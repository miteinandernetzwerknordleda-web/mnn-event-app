<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lokale Events App</title>
    
<link rel="manifest" href="/mnn-event-app/manifest.json">
	<meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
* {
    box-sizing: border-box; 
}
/* 1. GLOBALE STILE */

    #splashScreen {
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f4f7f6; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        z-index: 9999; 
        color: #8B4513; 
        font-size: 1.2em;
        text-align: center;
        transition: opacity 1s ease-out; 
    }

    #splashScreen.fade-out {
        opacity: 0;
        pointer-events: none; 
    }

    /* KORRIGIERT: Entfernter Border-Radius und Max-Width/Height für bessere Darstellung des Splash-Logos */
	.splash-logo {
        max-width: 90%; 
        max-height: 70vh; 
        height: auto;
        width: auto; 
        margin-bottom: 20px;
        border-radius: 0; 
    }	
	
    #splashScreen h1 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.8em;
    }

    #splashScreen p {
        font-style: italic;
        color: #666;
    }
    
    /* Copyright Styling */
    #splash-copyright {
        position: absolute; 
        bottom: 40px; 
        width: 100%;
        text-align: center;
        font-size: 0.8em;
        color: #666;
    }


    body {
        font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7f6;
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
        overflow-x: hidden;
    }

	.spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #8B4513; 
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto; 
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

/* 2. HEADER UND CONTAINER */

    #app-container {
        max-width: 600px;
        width: 100%;
        margin: 0 auto;
        padding-bottom: 80px;
        flex-grow: 1;
        background-color: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }

    #app-header { 
        background-color: #8B4513;
        color: white;
        padding: 10px 20px; 
        display: flex; 
        align-items: center; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 10;
		min-height: 60px; /* Garantiert eine Grundhöhe */
		height: auto;      /* Erlaubt dem Header zu wachsen */
		padding: 10px 20px;
    }

    /* KORRIGIERT: Logo Container und Logo selbst sind jetzt eindeutig definiert */
    #logo-container {
        margin-right: 15px; 
        display: flex;
        align-items: center;
    }

    #app-logo {
        height: 40px; 
        width: auto;
        /* margin-right: 15px; <- entfernt, da es jetzt im #logo-container ist */
        vertical-align: middle; 
        /* Zusätzliche Regeln, um sicherzustellen, dass das Bild angezeigt wird */
        min-width: 40px;
        min-height: 40px;
        display: block; 
    }
    
    #headerTitle { 
        margin: 0;
        padding: 0;
        font-size: 1.5em; 
        font-weight: bold;
        color: white;
        flex-grow: 1; 
        text-align: left; 
		display: flex;
		flex-direction: column; /* Stapelt Haupttitel und Sub-Header */
		justify-content: center;
		line-height: 1.1;       /* Engerer Zeilenabstand für die zwei Zeilen */
    }
    
    /* Styling für den Refresh Button */
    #refreshButton {
        background: none;
        /* KORRIGIERT: Randfarbe für das '↻' Symbol */
        border: 1px solid white; 
        color: white;           
        font-size: 1.4em; 
        cursor: pointer;
        padding: 5px 10px;
        margin-left: 15px;
        border-radius: 5px;
        transition: background-color 0.2s;
        line-height: 1; 
    }

    #refreshButton:hover {
        background-color: #A0522D; 
    }
    #refreshButton:active {
        background-color: #694429; 
    }
    /* ENDE Refresh Styling */

	#search-container {
        max-width: 600px;
        width: 100%;
        padding: 10px 20px;
        background-color: #f4f7f6; 
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        z-index: 5;
    }

    #searchInput {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 20px; 
        font-size: 1em;
        box-sizing: border-box; 
        transition: border-color 0.3s;
    }

    #searchInput:focus {
        outline: none;
        border-color: #8B4513; 
        box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.2);
    }

.sub-header {
    display: block;
    font-size: 0.55em;      /* Schön klein */
    font-weight: normal;
    opacity: 0.9;
    margin-top: 2px;
    color: #f4f7f6;         /* Etwas helleres Grau/Weiß für bessere Lesbarkeit auf Braun */
}

/* --- KATEGORIE-FILTER-STILE (Aktiviert) --- */
#filter-container {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    padding: 0 20px 10px; 
    background-color: #f4f7f6;
    overflow-x: auto; 
    white-space: nowrap; 
    -webkit-overflow-scrolling: touch; 
}

.filter-btn {
    display: inline-block;
    padding: 5px 12px; /* Etwas mehr Platz für den Text */
    margin: 4px 8px 4px 0;
    border: 1px solid #ccc;
    border-radius: 15px;
    background-color: white;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #333;
    font-weight: 500;
    white-space: nowrap; /* Verhindert Zeilenumbruch im Button */
}

.filter-btn:hover {
    background-color: #f5f5f5;
    border-color: #999;
}

.filter-btn.selected {
    /* Entferne hier background-color und color, 
       da wir das jetzt dynamisch per JS machen! */
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* --- ENDE KATEGORIE-FILTER-STILE --- */


/* 3. KARTEN-STIL */
    .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd; 
        border-left: 10px solid #007bff; 
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

	.card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1),
                    0 0 0 2px var(--event-color);
    }

    .card h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #8B4513;
        font-size: 1.1em;
    }

    .card p {
        margin: 4px 0;
        font-size: 0.9em;
        color: #000000;
    }
    
	/* Styling für die abgesagte Karte */
	.card-cancelled {
		background-color: #f9f9f9 !important;
		opacity: 0.8;
	}
	
    /* NEUER STIL FÜR MONATSTRENNUNG */
    .month-separator {
        background-color: #e8e8e8; /* Hintergrundfarbe des Trenners */
        color: #8B4513;            /* Braune Textfarbe */
        padding: 10px 20px;
        margin: 10px 0 0;
        font-size: 1.2em;
        font-weight: bold;
        position: sticky;          /* Wichtig: Lässt den Header kleben */
        top: 60px;                 /* Soll unter dem Haupt-Header (ca. 60px Höhe) kleben */
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Anpassung der Karten-Abstände */
    #app-content .card {
        margin: 15px 20px; /* Kartenabstand für die Trennung */
    }

    /* NEUER, KONSISTENTER STIL FÜR KALENDER-BUTTONS */
    .calendar-buttons {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
        text-align: center;
        /* Container auf volle Breite des Modals setzen */
        display: flex;
        flex-direction: column; 
        gap: 10px; /* Abstand zwischen den Buttons */
    }

    /* KORRIGIERT: Stil für Google Kalender Button (Blau) */
    .calendar-link-btn:first-child { 
        background-color: #4285F4; /* Google Blau */
        color: white;
    }

    .calendar-link-btn:first-child:hover {
        background-color: #3b78e7; 
    }

    /* KORRIGIERT: Stil für ICS Download Button (Grau/Braun) */
    .calendar-link-btn:last-child { 
        background-color: #6c757d; /* Dunkles Grau */
        color: white;
    }

    .calendar-link-btn:last-child:hover {
        background-color: #5a6268; 
    }

    .calendar-link-btn {
        display: block; 
        width: 100%; /* Beide Buttons nehmen volle Container-Breite ein */
        
        padding: 12px;
        margin: 0; 
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.2s;
        font-size: 1em;
        border: none;
        cursor: pointer;
        opacity: 0.9; 
    }


/* 3. KARTEN-STIL (Ergänzung für Datum & Abstand) */
    
    .card-content {
        flex-grow: 1;
        padding-left: 20px;
    }

    .date-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 40px;
        margin-right: 0px;
        color: #333;
        padding-top: 5px;
    }

	.date-day-num {
        font-size: 1.8em;
        font-weight: 700;
        line-height: 1;
        color: #8B4513;
    }

    .date-day-short {
        margin-top: 12px;
        font-size: 1.2em;
        font-weight: 600;
        text-transform: uppercase;
        line-height: 1;
    }

    /* 4. NAVIGATION */
    #navigation {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 600px;
        margin: 0 auto;
        /* HIER: Vier Buttons in der Leiste */
        display: flex;
        background-color: #343a40; 
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        z-index: 20;
    }

    .nav-btn {
        flex: 1;
        padding: 15px 5px; /* Etwas weniger Padding für 4 Buttons */
        color: white;
        text-align: center;
        text-decoration: none;
        font-size: 0.9em; /* Etwas kleinere Schrift */
        cursor: pointer;
        transition: background-color 0.3s;
        border-radius: 0;
        border: none;
        background: none;
        line-height: 1.1; 
    }

    .nav-btn:hover {
        background-color: #495057;
    }

    .nav-btn.active {
        background-color: #8B4513;
        font-weight: bold;
    }

/* 5. MODAL-STIL */

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 25px; 
        border-radius: 10px;
        width: 90%;
        max-width: 580px; 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation-name: animatetop;
        animation-duration: 0.4s
    }

    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 15%; opacity: 1}
    }
    
	.close {
		position: absolute; 
		top: 8px;      /* Kleiner Abstand vom oberen weißen Rand */
		right: 12px;   /* Kleiner Abstand vom rechten weißen Rand */
		color: #333;   /* Dunklere Farbe für besseren Kontrast auf Weiß */
		font-size: 28px; 
		font-weight: bold;
		line-height: 1;
		cursor: pointer;
		z-index: 1000; /* Stellt sicher, dass es über allem (auch dem Balken) liegt */
		padding: 5px;
	}

	.close:hover,
	.close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
	}

/* 6. RESPONSIVE ANPASSUNGEN (für kleinere Bildschirme) */
    @media (max-width: 600px) {
        #app-container {
            padding-bottom: 70px;
        }
        #navigation {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
	.modal-content {
		background-color: #fefefe;
		margin: 10% auto; 
		padding: 35px 20px 20px 20px; /* Oben mehr Padding (35px), um Platz für das X zu schaffen */
		border: 1px solid #888;
		border-radius: 10px;
		width: 90%;
		max-width: 580px; 
		box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
		position: relative; /* Das ist der Anker für das X */
	}
	
/* 6. MODAL STIL (Ergänzung für Bilder) */

    .event-image-container {
        text-align: center; 
        margin: 15px auto; 
        max-width: 100%; 
        border-radius: 5px;
        overflow: hidden;
        height: auto;
    }

    .event-image {
        max-width: 100%;
        width: 100%; 
        height: auto;
        display: block;
        min-height: 50px;
        border: none;
    }
	
    }

/* Zusätzliches Styling für die neuen Seiten-Container */
.static-view {
    padding: 20px;
    display: none; /* Standardmäßig versteckt */
    font-size: 1.1em;
}
.static-view h2 {
    color: #8B4513;
    border-bottom: 2px solid #8B4513;
    padding-bottom: 5px;
}
.static-view h3 {
    color: #8B4513;
}
.static-view a {
    color: #007bff;
    font-weight: bold;
    text-decoration: none;
}
.static-view a:hover {
    text-decoration: underline;
}

</style>
</head>
<body>

<div id="splashScreen">
    <img src="/mnn-event-app/Splashlogo.png" alt="Miteinander Netzwerk Nordleda Logo" class="splash-logo">
    <h1>
        EventApp
    </h1>
    <p>Lade Events...</p>
    <div id="splash-copyright">
        (c) 2026 Miteinander Netzwerk Nordleda<br>
		Version <span class="app-version-text"></span>
    </div>
</div>

<div class="container">
<header id="app-header">
    <div id="logo-container">
        <img id="app-logo" src="/mnn-event-app/logo.png" alt="Vereins Logo">
    </div>
    <h1 id="headerTitle">Veranstaltungen</h1>
    <button id="refreshButton">↻</button> 
</header>

<div id="search-container">
    <input type="text" id="searchInput" placeholder="Events, Anbieter oder Ort suchen...">
</div>

<div id="filter-container" style="display: none;">
    </div>
<div id="app-loader" style="text-align: center; padding-top: 50px; display: none;">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">Veranstaltungen werden geladen...</p>
</div>

    <div id="app-content" style="padding-bottom: 70px;">
    </div>
    
    <div id="whatsapp-view" class="static-view">
        
        <h2>WhatsApp Community</h2>
        <p>Tritt unserer Community bei, um um in verschiedenen Gruppen nach Lust und Laune über alles mögliche in unserem Nordleda zu chatten. Und wenn es eine Idee gibt, die unbedingt besprochen werden sollte, dann erstellt ihr selber eine Gruppe.<br>
			Reinschauen, Mitmachen, Diskutieren, Moderieren.</p>
        <div style="margin-top: 20px; text-align: center;">
            <a href="https://chat.whatsapp.com/JYa2h2T2EynJSRo2KApNiE" target="_blank" style="display: inline-block; background-color: #25D366; color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-size: 1.2em;">
                Community beitreten
            </a>
        </div>

        <hr style="margin: 40px 0; border-top: 1px solid #ddd;">
        
        <h2>WhatsApp Kanal für Veranstaltungen</h2>
        <p>Abonniert  unseren Kanal, um aktuelle Neuigkeiten, kurzfristige Informationen und Ankündigungen direkt auf euer Handy zu erhalten.<br>
		Dieser Kanal dient nur der Information durch uns.</p>
        <div style="margin-top: 20px; text-align: center;">
            <a href="https://whatsapp.com/channel/0029VbBsgtIK0IBZMmtQJ61J" target="_blank" style="display: inline-block; background-color: #25D366; color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-size: 1.2em;">
                Kanal abonnieren
            </a>
			<br>
			<br>
			<br>
        </div>
        
    </div>

    <div id="contact-view" class="static-view">
        
        <h2>Feedback, Anfragen & Support</h2>
        <p>Habet ihr allgemeine Fragen, möchtet ihr eine Veranstaltung melden oder benötigt ihr technischen Support für diese App?</p>
        <p>Bitte nutzt unsere zentrale E-Mail-Adresse.</p>
        
        <h3 style="color: #8B4513;">Zentrale Kontaktstelle:</h3>
        <div style="margin-top: 20px; margin-bottom: 40px;">
            E-Mail: <a href="mailto:miteinander.netzwerk.nordleda@gmail.com">miteinander.netzwerk.nordleda@gmail.com</a>
        </div>
        
        <hr style="margin: 40px 0; border-top: 1px solid #ddd;">
        
        <h2>Impressum</h2>
        <p><strong>Betreiber und Verantwortlich für den Inhalt:</strong></p>
        <p>
            Interessengruppe<br>
			Miteinander Netzwerk Nordleda<br>
            c/o Andreas Beckmann<br>
            Kampen 31 - 21765 Nordleda
        </p>

        <h3 style="color: #8B4513; margin-top: 25px;">Verantwortlich im Sinne des Presserechts (V.i.S.d.P.):</h3>
        <p>
            Andreas Beckmann<br>
            Kampen 31 - 21765 Nordleda
        </p>

        <h3 style="color: #8B4513; margin-top: 25px;">Kontakt:</h3>
        <p>
            E-Mail: <a href="mailto:miteinander.netzwerk.nordleda@gmail.com">miteinander.netzwerk.nordleda@gmail.com</a>
        </p>
        <p style="font-size: 0.9em; margin-top: 20px;">
            *Hinweis:* Wir sind bemüht, die Informationen in dieser App aktuell und korrekt zu halten. Da die App ausschließlich zur Bekanntmachung von lokalen Veranstaltungen dient, übernehmen wir keine Haftung für die Richtigkeit der Termine und Inhalte der Veranstalter.
        </p>
		<br>
		<p style="margin-top: 20px; font-size: 1em; color: #666;">
        App Version: <span class="app-version-text"></span>
    </p>
	<br>
	<br>
	<br>
    </div>
    <div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('eventModal')">×</span>
        </div>
</div>

<div id="veranstalterModal" class="modal">
    <div class="modal-content" id="veranstalterDetail">
        <span class="close" onclick="closeModal('veranstalterModal')">×</span>
        
        <h3 id="modalProviderName"></h3>
        <p><strong>Kontakt:</strong> <span id="modalProviderContact"></span></p>
        <p><strong>Info:</strong> <span id="modalProviderInfo"></span></p>
        <a id="modalProviderLink" href="#" target="_blank" style="color: #8B4513;">Zur Webseite</a>
        </div>
</div>
    
    <nav id="navigation">
        <button id="events-btn" class="nav-btn active" onclick="switchView('events')">Veranstaltungen</button>
        <button id="providers-btn" class="nav-btn" onclick="switchView('providers')">Anbieter</button>
        <button id="whatsapp-btn" class="nav-btn" onclick="switchView('whatsapp')">WhatsApp</button>
        <button id="contact-btn" class="nav-btn" onclick="switchView('contact')">Kontakt</button>
    </nav>
	
</div>


<script>
    // --- 1. KONFIGURATION ---
    const API_KEY = 'AIzaSyDXtPSF4EuneOi_l3vCAKEtRHjD1gIiMBg';
    const CALENDAR_ID = 'miteinander.netzwerk.nordleda@gmail.com';
	const APP_VERSION = "1.4.031"; 
    const MIN_SPLASH_DURATION = 3000; 
    
    // NEUE KONSTANTEN FÜR ALLE FEIERTAGS-LOGOS
    const DEFAULT_LOGO_PATH = 'logo.png'; 
    const ADVENT_LOGO_BASE = 'mnnsplashadv'; // mnnsplashadv1.jpg, mnnsplashadv2.jpg usw.
    const LOGO_EXTENSION = '.jpg'; 
    
    // ZUSÄTZLICHE FEIERTAGS-KONSTANTEN
    const CHRISTMAS_LOGO = 'mnnsplashtannen' + LOGO_EXTENSION;
    const NEW_YEARS_LOGO = 'mnnsplashfeuerwerk' + LOGO_EXTENSION;
    const VALENTINE_LOGO = 'mnnsplashvalentins' + LOGO_EXTENSION;
    const EASTER_LOGO = 'mnnsplashostern' + LOGO_EXTENSION;
    const UNITY_DAY_LOGO = 'mnnsplashdeutsch' + LOGO_EXTENSION; // Tag der Deutschen Einheit (03.10.)
    
    // Basisdaten für die Anbieter
    const providers = [
        { id: 1, name: "TSV Nordleda", contact: "Jürgen Hoberg Tel. 04758-546", info: "Der lokale Sportverein mit verschiedenen Angeboten", link: "https://www.nordleda.de/vereine-und-choere/tsv-nordleda-ev/", color: "#a4bdfc" },
        { id: 2, name: "DRK Nordleda", contact: "Anja von Bebern Tel. 04758-679", info: "Der DRK Ortsverein bietet mit dem Arbeitskreis viele verschiedene Veranstaltungen", color: "#ff887c" },
        { id: 3, name: "Schützenverein Nordleda", contact: "Über das Kontaktformular auf der Webseite", info: "Schützenverein Nordleda von 1953 e.V.", link: "https://www.svnordleda.de/", color: "#7ae7bf" },
        { id: 4, name: "Kirchengemeinde Nordleda", contact: "meike.mueller-bilgenroth@evlka.de", info: "Die Kirchengemeinde St. Nicolai in Nordleda", link: "https://www.kk-ch.de/gemeinden/nordleda/", color: "#dbadff" },
		{ id: 5, name: "taktlos-Chor", contact: "Über das Kontaktformular auf der Webseite", info: "...der a cappella Männerchor", link: "https://www.gruppe-taktlos.de/", color: "#5484ed" },
		{ id: 6, name: "LoGos-Chor Nordleda", contact: "Gunda Knust Tel. 04758-326", info: "Lobpreis-Gospelchor", color: "#8A2BE2" },
		{ id: 7, name: "FamilienHaven Nordleda", contact: "Serina Naß Tel. 015256302291", info: "Delfi Kurse - Fachkraft für Beikost, Elternvorbereitung, Säuglingspflege, Achtsamkeit", link: "https://www.instagram.com/delfinordleda/", color: "#fbd75b" },
		{ id: 8, name: "Gewerbegemeinschaft Nordleda", contact: "Hans-Hermann Ropers Tel. 04758-444", info: "Gewerbegemeinschafterbegemeinschaft des Ortes Nordleda", color: "#ffacac" },
		{ id: 9, name: "CDU Nordleda", contact: "Hans-Hermann Ropers Tel. 04758-444", info: "CDU Ortsverband Nordleda", link: "https://www.cdu-land-hadeln.de/ortsverbaende/nordleda/", color: "#000000" },
		{ id: 10, name: "SoVD Neuenkirchen/Nordleda", contact: "Über das Kontaktformular auf der Webseite", info: "Sozialverband Deutschland", link: "https://www.sovd-cuxhaven.de/verband-990125?verbandid=991896&cHash=f253ff976383e4a74d925e676582cb7b", color: "#D3D3D3" },
		{ id: 11, name: "Miteinander Netzwerk Nordleda", contact: "miteinander.netzwerk.nordleda@gmail.com", info: "Interessengruppe zur Stärkung des Gemeinschaftsgefüges", link: "https://sites.google.com/view/netzwerknordleda/start", color: "#EE00EE" },
		{ id: 12, name: "Feuerwehr Nordleda", contact: "info@feuerwehr-nordleda.de", info: "Freiwillige Feuerwehr und Jugendfeuerwehr Nordleda", link: "https://www.instagram.com/ffw_nordleda/?hl=de", color: "#FF0000" },
		{ id: 13, name: "Kindergarten Nordleda", contact: "Nicola Schriever Tel. 04758-1287", info: "DRK Kindertagesstätte Nordleda", link: "https://www.drk-cuxhaven-hadeln.de/kita-nordleda.html", color: "#00FFFF" },
		{ id: 99, name: "Freier Anbieter", contact: "Evtl. über die Veranstaltungsbeschreibung", info: "verschiedene Anbieter von Veranstaltungen", color: "#F8F8FF" }

    ];
	
	const contentDiv = document.getElementById('app-content');
    const headerTitle = document.getElementById('headerTitle');
	const searchInput = document.getElementById('searchInput');
    const eventModal = document.getElementById('eventModal');
    const veranstalterModal = document.getElementById('veranstalterModal');
	const appLoader = document.getElementById('app-loader');
	const splashScreen = document.getElementById('splashScreen');
    const filterContainer = document.getElementById('filter-container'); 
    
    const searchContainer = document.getElementById('search-container'); 
    
    const whatsappView = document.getElementById('whatsapp-view');
    const contactView = document.getElementById('contact-view');

    let dynamicEvents = [];
    let currentFilterId = null; 
    let startTime; 
    window.eventDetailsCache = null; 
	let lastKnownEvents = [];
	let currentView = 'events';

    // --- 2. HILFSFUNKTIONEN ---
	
    function extractProviderId(titleString) {
        if (!titleString) return null;
        const match = titleString.trim().match(/\(ID:(\d+)\)/i);
        return match ? parseInt(match[1]) : null;
    }
    
    function cleanTitle(titleString) {
        if (!titleString) return 'Unbekanntes Event';
        return titleString.replace(/\s*\(ID:\d+\)\s*/i, '').trim();
    }
    
    function getEmbeddableDriveLink(description) {
        if (!description) return null;
        const fileIdRegex = /(?:file\/d\/|id=)([a-zA-Z0-9_-]+)/;
        const match = description.match(fileIdRegex);
        
        if (match && match[1]) {
            const fileId = match[1].trim();
            return `https://drive.google.com/thumbnail?id=${fileId}&sz=w600`; 
        }
        return null;
    }

/**
 * Berechnet die optimale Textfarbe (Schwarz oder Weiß) basierend auf der Hintergrundhelligkeit.
 * @param {string} hexcolor - Der Farbcode (z.B. #0000FF oder ##0000FF)
 * @returns {string} - 'black' oder 'white'
 */
function getContrastYIQ(hexcolor) {
    if (!hexcolor) return 'black';

    // 1. Fehlerbereinigung: Entfernt alle Rauten und setzt genau eine davor
    let cleanHex = hexcolor.replace(/#/g, "");
    
    // 2. Unterstützung für Kurzschreibweise (z.B. #f00 -> #ff0000)
    if (cleanHex.length === 3) {
        cleanHex = cleanHex.split('').map(char => char + char).join('');
    }

    // Falls der Hex-Code nach der Reinigung ungültig ist
    if (cleanHex.length !== 6) {
        console.warn("Ungültiger Farbcode: " + hexcolor);
        return 'black';
    }

    // 3. Umwandlung in RGB-Werte
    const r = parseInt(cleanHex.substr(0, 2), 16);
    const g = parseInt(cleanHex.substr(2, 2), 16);
    const b = parseInt(cleanHex.substr(4, 2), 16);

    // 4. YIQ-Formel zur Berechnung der wahrgenommenen Helligkeit
    // (Standard nach FCC-Richtlinien)
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;

    // 5. Schwellenwert-Logik:
    // Ein Wert von 128 ist die Mitte. Wir nehmen 160, damit hellere Farben
    // (wie Hellgrau oder Gelb) früher schwarzen Text erhalten.
    return (yiq >= 160) ? 'black' : 'white';
}

// ERWEITERTE FEIERTAGS-LOGIK START

function getFirstAdventDate(year) {
    // 1. Advent ist der Sonntag, der dem 30. November am nächsten liegt (fällt zwischen 27. Nov. und 3. Dez.).
    const nov30 = new Date(year, 10, 30); // Monat 10 ist November (0-basiert)
    const dayOfWeek = nov30.getDay(); // 0 (Sonntag) bis 6 (Samstag)
    
    // Berechne das Datum des Sonntags am oder vor dem 30. Nov.
    let date = 30 - dayOfWeek;
    
    // Wenn das berechnete Datum vor dem 27. Nov. liegt, brauchen wir den nächsten Sonntag (Dez 1, 2, oder 3)
    if (date < 27) {
        date = 30 + (7 - dayOfWeek);
    }
    
    const firstAdvent = new Date(year, 10, date); 
    firstAdvent.setHours(0, 0, 0, 0); 
    return firstAdvent;
}

function getEasterDate(year) {
    // Gauss'sche Osterformel
    const a = year % 19;
    const b = year % 4;
    const c = year % 7;
    const k = Math.floor(year / 100);
    const p = Math.floor(k / 3);
    const q = Math.floor(k / 4);
    const M = Math.floor((15 + k - p - q) % 30);
    const N = Math.floor((4 + k - q) % 7);
    const d = Math.floor((19 * a + M) % 30);
    const e = Math.floor((2 * b + 4 * c + 6 * d + N) % 7);
    let day = 22 + d + e;
    let month = 3; // März
    
    if (day > 31) {
        month = 4; // April
        day = day - 31;
    }
    
    if (d === 29 && e === 6 && year >= 1900) {
        day = 19;
        month = 4; // 19. April
    }
    if (d === 28 && e === 6 && a > 10 && year >= 1900) {
        day = 18;
        month = 4; // 18. April
    }
    
    // Ostersonntag
    const easter = new Date(year, month - 1, day);
    easter.setHours(0, 0, 0, 0);
    return easter;
}

// ERWEITERTE FEIERTAGS-LOGIK START

// ... (getFirstAdventDate und getEasterDate bleiben unverändert) ...

function getSplashLogoPath() {
    // Helper-Funktion, um Datumsbereiche leicht zu prüfen
    // month ist 0-basiert (Jan=0, Dez=11)
    const checkDateRange = (now, monthStart, dayStart, monthEnd, dayEnd) => {
        const year = now.getFullYear();
        const start = new Date(year, monthStart, dayStart);
        const end = new Date(year, monthEnd, dayEnd);
        end.setHours(23, 59, 59, 999);
        return now.getTime() >= start.getTime() && now.getTime() <= end.getTime();
    };
    
    const now = new Date();
    const year = now.getFullYear();
    
    // --- 1. Fixe Feiertage (Jahr-übergreifend) ---
    
    // 1.1 Neujahr (01.01.)
    if (checkDateRange(now, 0, 1, 0, 1)) {
        return { path: NEW_YEARS_LOGO, text: "Frohes neues Jahr!" };
    }
    
    // 1.2 Valentinstag (14.02.)
    if (checkDateRange(now, 1, 14, 1, 14)) {
        return { path: VALENTINE_LOGO, text: "Alles Liebe zum Valentinstag!" };
    }
    
    // 1.3 Tag der Deutschen Einheit (03.10.)
    if (checkDateRange(now, 9, 3, 9, 3)) {
        return { path: UNITY_DAY_LOGO, text: "Herzliche Grüße zum Tag der Deutschen Einheit!" };
    }
    
    // --- 2. Bewegliche Feiertage (Ostern) ---
    const easterSunday = getEasterDate(year);
    const goodFriday = new Date(easterSunday);
    goodFriday.setDate(easterSunday.getDate() - 2);
    const easterMonday = new Date(easterSunday);
    easterMonday.setDate(easterSunday.getDate() + 1);
    
    // Ostern (Karfreitag bis Ostermontag)
    if (now.getTime() >= goodFriday.getTime() && now.getTime() <= easterMonday.getTime()) {
        return { path: EASTER_LOGO, text: "Frohe Ostern!" };
    }

    // --- 3. Silvester (31.12.) ---
    // Muss vor Weihnachten geprüft werden, da Weihnachten an manchen Tagen des Jahres am Ende liegt.
    if (checkDateRange(now, 11, 31, 11, 31)) {
        return { path: NEW_YEARS_LOGO, text: "Guten Rutsch!" };
    }
    
    // --- 4. Weihnachten (Heiligabend, 1. & 2. Weihnachtstag: 24.12. bis 26.12.) ---
    if (checkDateRange(now, 11, 24, 11, 26)) {
        return { path: CHRISTMAS_LOGO, text: "Frohe Weihnachten!" };
    }
    
    // --- 5. Adventszeit (Prüft den 1., 2., 3., 4. Advent) ---
    const firstAdvent = getFirstAdventDate(year);
    const MS_PER_DAY = 1000 * 60 * 60 * 24;
    
    // Wir prüfen die Zeitspanne vom 1. Advent bis zum 24. Dezember (exklusiv)
    const christmasEveStart = new Date(year, 11, 24); 
    christmasEveStart.setHours(0, 0, 0, 0); 
    
    if (now.getTime() >= firstAdvent.getTime() && now.getTime() < christmasEveStart.getTime()) {
        
        const diffTime = now.getTime() - firstAdvent.getTime();
        const diffDays = Math.floor(diffTime / MS_PER_DAY);
        
        // Adventswoche: 0-6 Tage = 1. Advent, 7-13 Tage = 2. Advent, etc.
        let adventWeek = Math.floor(diffDays / 7);
        
        // Logik: 0 -> 1, 1 -> 2, 2 -> 3, 3 -> 4
        let logoIndex = adventWeek + 1; 
        
        // Begrenzung: Wir sind definitiv in der Adventszeit, aber maximal 4. Advent.
        if (logoIndex > 4) {
             logoIndex = 4;
        }

        const weekNumber = logoIndex;
        return { path: ADVENT_LOGO_BASE + logoIndex + LOGO_EXTENSION, text: `Frohe ${weekNumber}. Adventswoche!` };
    }


    // --- 6. Standard-Logo (Wenn kein Feiertag) ---
    return { path: DEFAULT_LOGO_PATH, text: "Lade Events..." };
}
// ERWEITERTE FEIERTAGS-LOGIK END


// HILFSFUNKTIONEN FÜR KALENDER-BUTTONS
function formatToCalendarDateString(dateObject, isAllDay) {
    // Google Calendar URL und ICS verwenden das YYYYMMDD-Format für Ganztagesevents
    const year = dateObject.getFullYear();
    const month = ('0' + (dateObject.getMonth() + 1)).slice(-2);
    const day = ('0' + dateObject.getDate()).slice(-2);

    if (isAllDay) {
        return `${year}${month}${day}`; // YYYYMMDD
    } else {
        // YYYYMMDDTHHMMSS (Lokale Zeit)
        const hour = ('0' + dateObject.getHours()).slice(-2);
        const minute = ('0' + dateObject.getMinutes()).slice(-2);
        return `${year}${month}${day}T${hour}${minute}00`; 
    }
}


	function getGoogleCalendarUrl(event) {
    // 1. Sicherheits-Checks für Texte
    const title = encodeURIComponent(event.title || 'Veranstaltung');
    
    // Falls Beschreibung fehlt, nutzen wir einen leeren String
    const rawDesc = event.description || ''; 
    const description = encodeURIComponent(rawDesc.replace(/\n/g, ' '));
    
    const location = encodeURIComponent(event.location || '');
    
    // 2. Zeiten bestimmen
    let isAllDay = !event.endDate || event.endDate === ''; 
    let startMoment = new Date(event.sortDate); 
    let endMoment;

    // Startzeitpunkt parsen
    if (isAllDay) {
        startMoment.setHours(0, 0, 0, 0); 
    } else {
        const dateStr = event.date || ""; // Sicherstellen, dass es ein String ist
        const timeMatch = dateStr.match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0, 0);
        }
    }
    
    // Endzeitpunkt parsen
    if (isAllDay) {
        endMoment = new Date(startMoment);
        endMoment.setDate(endMoment.getDate() + 1);
    } else {
        endMoment = new Date(startMoment);
        const endDateStr = event.endDate || ""; // Sicherstellen, dass es ein String ist
        const endTimeMatch = endDateStr.match(/(\d{2}):(\d{2})/);
        if (endTimeMatch) {
            endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0, 0);
            if(endMoment.getTime() < startMoment.getTime()) {
                endMoment.setDate(endMoment.getDate() + 1);
            }
        } else {
            endMoment.setHours(startMoment.getHours() + 1);
        }
    }

    // 3. Formatierung (nutzt deine bestehende Hilfsfunktion)
    let startFormatted = formatToCalendarDateString(startMoment, isAllDay);
    let endFormatted = formatToCalendarDateString(endMoment, isAllDay);
    
    const datesParam = `${startFormatted}/${endFormatted}`;

    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${datesParam}&details=${description}&location=${location}&sf=true`;
}

function getICSContent(event) {
    const provider = providers.find(p => p.id == event.providerId);
    const organizer = provider ? `ORGANIZER;CN=${provider.name}:mailto:${provider.contact || 'noreply@nordleda.de'}` : '';

    // Datum- & Zeit-Objekte (gleiche Logik wie in getGoogleCalendarUrl)
    let isAllDay = event.endDate === ''; 
    let startMoment = new Date(event.sortDate); 
    let endMoment;

    if (isAllDay) {
        startMoment.setHours(0, 0, 0, 0); 
        endMoment = new Date(startMoment);
        endMoment.setDate(endMoment.getDate() + 1);
    } else {
        const timeMatch = event.date.match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0, 0);
        }
        endMoment = new Date(startMoment);
        const endTimeMatch = event.endDate.match(/(\d{2}):(\d{2})/);
        if (endTimeMatch) {
            endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0, 0);
            if(endMoment.getTime() < startMoment.getTime()) {
                endMoment.setDate(endMoment.getDate() + 1);
            }
        } else {
            endMoment.setHours(startMoment.getHours() + 1);
        }
    }
    
    // ICS benötigt YYYYMMDDTHHMMSS im lokalen Format oder DTSTART;VALUE=DATE für all-day
    const icsFormatDate = (date) => {
        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        return `${year}${month}${day}`;
    };
    
    const icsFormatTime = (date) => {
        const hour = ('0' + date.getHours()).slice(-2);
        const minute = ('0' + date.getMinutes()).slice(-2);
        const second = ('0' + date.getSeconds()).slice(-2);
        return `T${hour}${minute}${second}`;
    }
    
    let icsStartLine;
    let icsEndLine;
    
    if (isAllDay) {
        // DTSTART;VALUE=DATE:YYYYMMDD
        icsStartLine = `DTSTART;VALUE=DATE:${icsFormatDate(startMoment)}`;
        // DTEND;VALUE=DATE:YYYYMMDD (exklusiv, also +1 Tag)
        icsEndLine = `DTEND;VALUE=DATE:${icsFormatDate(endMoment)}`; 
    } else {
        // DTSTART:YYYYMMDDTHHMMSS
        icsStartLine = `DTSTART:${icsFormatDate(startMoment)}${icsFormatTime(startMoment)}`;
        icsEndLine = `DTEND:${icsFormatDate(endMoment)}${icsFormatTime(endMoment)}`; 
    }


    const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//MiteinanderNetzwerkNordleda//EventApp//DE',
        'CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        `UID:${event.id}-${Date.now()}@nordleda.de`,
        `DTSTAMP:${new Date().toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0, 15)}Z`,
        icsStartLine,
        icsEndLine,
        `SUMMARY:${event.title}`,
        // Description muss Zeilenumbrüche mit \n und andere Sonderzeichen maskieren
        `DESCRIPTION:${event.description.replace(/,/g, '\\,').replace(/\n/g, '\\n')}`,
        `LOCATION:${event.location.replace(/,/g, '\\,')}`,
        organizer,
        'END:VEVENT',
        'END:VCALENDAR'
    ].join('\n');

    return icsContent;
}

	function downloadICS(event) {
    if (!event) {
        alert("Keine Event-Daten gefunden.");
        return;
    }

    // 1. Daten vorbereiten
    const title = event.title || 'Veranstaltung';
    const description = (event.description || '').replace(/\n/g, '\\n');
    const location = event.location || '';
    
    // 2. Zeitstempel berechnen (nutzt die Logik aus der Google-Funktion)
    const isAllDay = !event.endDate || event.endDate === '';
    let startMoment = new Date(event.sortDate);
    let endMoment = new Date(startMoment);

    if (!isAllDay) {
        const timeMatch = (event.date || "").match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0);
            
            const endTimeMatch = (event.endDate || "").match(/(\d{2}):(\d{2})/);
            if (endTimeMatch) {
                endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0);
            } else {
                endMoment.setHours(startMoment.getHours() + 1);
            }
        }
    } else {
        // Ganztägig: Ende ist der nächste Tag
        endMoment.setDate(endMoment.getDate() + 1);
    }

    // Hilfsfunktion für das ICS-Datumsformat: YYYYMMDDTHHMMSS
    const formatICS = (date, allDay) => {
        const iso = date.toISOString().replace(/-|:|\.\d+/g, '');
        return allDay ? iso.slice(0, 8) : iso;
    };

    const startStr = formatICS(startMoment, isAllDay);
    const endStr = formatICS(endMoment, isAllDay);

    // 3. ICS Datei-Inhalt zusammenbauen
    const icsContent = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//MNN Event App//DE",
        "BEGIN:VEVENT",
        `DTSTART${isAllDay ? ';VALUE=DATE' : ''}:${startStr}`,
        `DTEND${isAllDay ? ';VALUE=DATE' : ''}:${endStr}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        "END:VEVENT",
        "END:VCALENDAR"
    ].join("\r\n");

    // 4. Download auslösen
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.setAttribute('download', `${title.replace(/[^a-z0-9]/gi, '_')}.ics`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
function downloadICS(event) {
    if (!event) {
        alert("Keine Event-Daten gefunden.");
        return;
    }

    // 1. Daten vorbereiten
    const title = event.title || 'Veranstaltung';
    const description = (event.description || '').replace(/\n/g, '\\n');
    const location = event.location || '';
    
    // 2. Zeitstempel berechnen (nutzt die Logik aus der Google-Funktion)
    const isAllDay = !event.endDate || event.endDate === '';
    let startMoment = new Date(event.sortDate);
    let endMoment = new Date(startMoment);

    if (!isAllDay) {
        const timeMatch = (event.date || "").match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0);
            
            const endTimeMatch = (event.endDate || "").match(/(\d{2}):(\d{2})/);
            if (endTimeMatch) {
                endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0);
            } else {
                endMoment.setHours(startMoment.getHours() + 1);
            }
        }
    } else {
        // Ganztägig: Ende ist der nächste Tag
        endMoment.setDate(endMoment.getDate() + 1);
    }

    // Hilfsfunktion für das ICS-Datumsformat: YYYYMMDDTHHMMSS
    const formatICS = (date, allDay) => {
        const iso = date.toISOString().replace(/-|:|\.\d+/g, '');
        return allDay ? iso.slice(0, 8) : iso;
    };

    const startStr = formatICS(startMoment, isAllDay);
    const endStr = formatICS(endMoment, isAllDay);

    // 3. ICS Datei-Inhalt zusammenbauen
    const icsContent = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//MNN Event App//DE",
        "BEGIN:VEVENT",
        `DTSTART${isAllDay ? ';VALUE=DATE' : ''}:${startStr}`,
        `DTEND${isAllDay ? ';VALUE=DATE' : ''}:${endStr}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        `LOCATION:${location}`,
        "END:VEVENT",
        "END:VCALENDAR"
    ].join("\r\n");

    // 4. Download auslösen
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.setAttribute('download', `${title.replace(/[^a-z0-9]/gi, '_')}.ics`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
// ENDE HILFSFUNKTIONEN FÜR KALENDER-BUTTONS

// Diese Funktion füllt die Nummern überall ein
	function injectVersionNumber() {
    const versionFields = document.querySelectorAll('.app-version-text');
    console.log("Gefundene Versions-Felder:", versionFields.length); // Test für die Konsole
    versionFields.forEach(field => {
        field.textContent = APP_VERSION;
    });
}


// --- 3. DATENABRUF VON GOOGLE KALENDER ---
function fetchCalendarEvents() {
    startTime = Date.now(); 
    
    // 1. localStorage laden
    const savedEvents = localStorage.getItem('cached_events');
    let lastUpdateStr = ""; 

    if (savedEvents) {
        try {
            const data = JSON.parse(savedEvents);
            // Wir prüfen, ob es das neue Objekt-Format ist oder nur ein Array
            const eventsToLoad = Array.isArray(data) ? data : (data.events || []); 
            lastUpdateStr = data.updatedAt || "unbekannt";

            lastKnownEvents = eventsToLoad.map(ev => ({
                ...ev,
                sortDate: new Date(ev.sortDate)
            }));

            // OFFLINE-TITEL SETZEN (Wird nur im Erfolgsfall überschrieben)
            headerTitle.innerHTML = `OFFLINE <span class="sub-header">Stand: ${lastUpdateStr}</span>`;
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    appLoader.style.display = 'none';
                    applyCategoryFilter(currentFilterId);
					checkForDeepLink();
                });
            } else {
                appLoader.style.display = 'none';
                applyCategoryFilter(currentFilterId);
				checkForDeepLink();
            }
        } catch (e) { console.error("Cache Fehler:", e); }
    } else {
        // Nur wenn gar kein Cache existiert
        headerTitle.textContent = "Veranstaltungen";
    }
    
    const hideSplash = () => {
        const elapsedTime = Date.now() - startTime;
        const remainingTime = MIN_SPLASH_DURATION - elapsedTime;
        const target = Math.max(0, remainingTime);
        setTimeout(() => {
            splashScreen.classList.add('fade-out');
            setTimeout(() => { splashScreen.style.display = 'none'; }, 1000);
        }, target);
    };

    // WICHTIG: Hier darf KEIN headerTitle.textContent mehr stehen!

    if (lastKnownEvents.length === 0) { contentDiv.innerHTML = ''; }

    const threeMonthsFromNow = new Date();
    threeMonthsFromNow.setDate(threeMonthsFromNow.getDate() + 90);
    const timeMaxParam = threeMonthsFromNow.toISOString();

    const API_URL = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${API_KEY}&timeMin=${(new Date()).toISOString()}&timeMax=${timeMaxParam}&singleEvents=true&orderBy=startTime`;

    fetch(API_URL)
        .then(response => {
            if (!response.ok && response.status !== 0) {
                throw new Error(`HTTP error! status: ${response.status}.`);
            }
            return response.json();
        })
        .then(data => {
            // ... (Dein Mapping-Block bleibt gleich wie zuvor) ...
	dynamicEvents = data.items.map((item, index) => {
		const rawTitle = item.summary || '';
		
		// Start- und Endzeit extrahieren
		const startStr = item.start.dateTime || item.start.date;
		const endStr = item.end.dateTime || item.end.date;
		
		const eventStart = new Date(startStr);
		const eventEnd = new Date(endStr);

		// Wir extrahieren die reine Uhrzeit für das Ende, falls vorhanden
		let formattedEndTime = "";
		if (item.end.dateTime) {
			formattedEndTime = eventEnd.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
	}

    return {
		id: item.id || index, // Wenn keine Google-ID da ist, nimm die Zeilennummer
        title: item.summary,
        // Das Start-Datum formatiert
        date: eventStart.toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
        // Das NEUE FELD für die End-Uhrzeit
        endDate: formattedEndTime, 
        dayOfMonth: eventStart.getDate(),
        dayOfWeekShort: eventStart.toLocaleDateString('de-DE', { weekday: 'short' }).slice(0, 2),
        location: item.location || 'Keine Angabe',
        description: item.description || 'Keine weitere Beschreibung vorhanden.',
        providerId: extractProviderId(rawTitle),
        sortDate: new Date(eventStart.getFullYear(), eventStart.getMonth(), eventStart.getDate())
    };
}).filter(event => event.title.toLowerCase().indexOf('blockiert') === -1);
            
            // NEUES SPEICHERFORMAT
            lastKnownEvents = dynamicEvents; 
            const cacheObject = {
                events: dynamicEvents,
                updatedAt: new Date().toLocaleString('de-DE', { 
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
                })
            };
            localStorage.setItem('cached_events', JSON.stringify(cacheObject));
            
            // ERST HIER: Online-Titel setzen (entfernt den Offline-Zusatz)
            headerTitle.textContent = "Veranstaltungen";
            
            appLoader.style.display = 'none';
            createFilterButtons(); 
            filterContainer.style.display = 'block';
            applyCategoryFilter(null);
            hideSplash(); 
			checkForDeepLink();
        })
        .catch(error => {
            console.warn("Nutze Offline-Daten");
            appLoader.style.display = 'none';
            hideSplash(); 
			checkForDeepLink();
            
            if (lastKnownEvents && lastKnownEvents.length > 0) {
                // Falls aus irgendeinem Grund die Überschrift oben nicht gesetzt wurde:
                if (!headerTitle.innerHTML.includes("Stand:")) {
                    headerTitle.innerHTML = `OFFLINE <span class="sub-header">Stand: ${lastUpdateStr || 'offline'}</span>`;
                }
                createFilterButtons(); 
                filterContainer.style.display = 'block';
                applyCategoryFilter(null);
            } else {
                contentDiv.innerHTML = `<p style="margin: 20px; color: red;">Offline: Keine Daten gespeichert.</p>`;
            }
        });
}
	
// --- 4. FUNKTIONEN ZUM RENDERN DER LISTEN (MIT STATUS-LOGIK) ---
function renderEventList(eventsToRender = dynamicEvents) {
    contentDiv.innerHTML = '';
    eventsToRender.sort((a, b) => a.sortDate - b.sortDate);

    if (eventsToRender.length === 0) {
        contentDiv.innerHTML = `<p style="margin: 20px;">Keine zukünftigen Veranstaltungen gefunden.</p>`;
        return;
    }
    
    let currentMonth = null;
    const dateFormatter = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' });

    eventsToRender.forEach(event => {
        const provider = providers.find(p => p.id == event.providerId);
        const providerName = provider ? provider.name : "Unbekannter Anbieter";
        const cardColor = provider ? provider.color : '#aaaaaa';
        
        const titleUpper = (event.title || "").toUpperCase();
        const isCancelled = titleUpper.includes("ABGESAGT") || titleUpper.includes("FÄLLT AUS");
        const isMoved = titleUpper.includes("VERSCHOBEN");
        const isChanged = titleUpper.includes("ÄNDERUNG");

        let statusColor = cardColor;
        let statusLabel = '';
        if (isCancelled) {
            statusColor = '#d93025';
            statusLabel = '<strong style="color: #d93025; font-size: 1.1em; display: block; margin-bottom: 4px;">⚠️ FÄLLT AUS</strong>';
        } else if (isMoved) {
            statusColor = '#ffc107';
            statusLabel = '<strong style="color: #e6a700; font-size: 1.1em; display: block; margin-bottom: 4px;">📅 VERSCHOBEN</strong>';
        } else if (isChanged) {
            statusColor = '#2196F3';
            statusLabel = '<strong style="color: #0d47a1; font-size: 1.1em; display: block; margin-bottom: 4px;">ℹ️ ÄNDERUNG</strong>';
        }

        const monthAndYear = dateFormatter.format(event.sortDate);
        if (monthAndYear !== currentMonth) {
            currentMonth = monthAndYear;
            const separator = document.createElement('div');
            separator.className = 'month-separator';
            separator.textContent = currentMonth;
            contentDiv.appendChild(separator);
        }
		
        const displayTitle = (event.title || "")
			.replace(/ABGESAGT[:]?/i, '')
			.replace(/FÄLLT AUS[:]?/i, '')
			.replace(/VERSCHOBEN[:]?/i, '')
			.replace(/ÄNDERUNG[:]?/i, '')
			.replace(/NEU[:]?/i, '')
			.replace(/\(ID[:]?\s*\d+\)/i, '') // <-- Diese Zeile entfernt (ID:3), (ID: 3) etc.
			.trim();

        const card = document.createElement('div');
        card.className = `card ${isCancelled ? 'card-cancelled' : ''}`;
        card.style.borderLeftColor = statusColor;
        card.style.setProperty('--event-color', statusColor);
        card.style.display = 'flex';
        card.style.alignItems = 'flex-start'; 
		
        card.innerHTML = `
            <div class="date-container" style="${isCancelled ? 'opacity: 0.5;' : ''}">
                <div class="date-day-num">${event.dayOfMonth}</div>
                <div class="date-day-short">${event.dayOfWeekShort}</div>
            </div>
            <div class="card-content">
                ${statusLabel}
                <h3 style="${isCancelled ? 'text-decoration: line-through; color: #888; margin-top: 0;' : 'margin-top: 0;'}">
                    ${displayTitle} 
                </h3>
                <p>Datum: ${event.date}</p>
                <p>Anbieter: <strong>${providerName}</strong></p>
            </div>
        `;
        
        card.onclick = () => showEventDetails(event);
        contentDiv.appendChild(card);
    });
}

// --- FUNKTIONEN FÜR KATEGORIE-FILTER ---
function createFilterButtons() {
    const filterContainer = document.getElementById('filter-container');
    if (!filterContainer) return;
    filterContainer.innerHTML = '';
    
    const firstBtnText = (currentView === 'providers') ? 'Alle Anbieter' : 'Alle Events';

    const allBtn = document.createElement('span');
    allBtn.className = 'filter-btn' + (currentFilterId === null ? ' selected' : '');
    allBtn.textContent = firstBtnText;
    
    if (currentFilterId === null) {
        allBtn.style.backgroundColor = '#8B4513';
        allBtn.style.color = 'white';
        allBtn.style.borderColor = '#8B4513';
    }

    allBtn.onclick = (e) => {
        e.stopPropagation();
        if(typeof searchInput !== 'undefined') searchInput.value = ''; 
        applyCategoryFilter(null);
    };
    filterContainer.appendChild(allBtn);

    const displayProviders = [...providers].sort((a, b) => a.id - b.id);

    displayProviders.forEach(provider => {
        const btn = document.createElement('span');
        const isSelected = (currentFilterId == provider.id);
        
        btn.className = 'filter-btn' + (isSelected ? ' selected' : '');
        btn.textContent = provider.name;
        btn.style.borderColor = provider.color || '#ccc';

		if (isSelected) {
            btn.style.setProperty('background-color', provider.color, 'important');
            btn.style.setProperty('border-color', provider.color, 'important');
            
            // Hier erzwingen wir die Kontrastfarbe
            const textColor = getContrastYIQ(provider.color);
            btn.style.setProperty('color', textColor, 'important');
        } else {
            btn.style.backgroundColor = 'white';
            btn.style.color = '#333';
            btn.style.borderColor = provider.color || '#ccc';
        }

        btn.onclick = (e) => {
            e.stopPropagation();
            if(typeof searchInput !== 'undefined') searchInput.value = ''; 
            applyCategoryFilter(provider.id);
        };
        filterContainer.appendChild(btn);
    });
}

function applyCategoryFilter(providerId) {
    currentFilterId = providerId;
	
	// Zeichnet die Buttons neu, damit der "selected" Rahmen an der richtigen Stelle ist
    createFilterButtons();
    
    if (currentView === 'providers') {
        // Wenn wir bei den Anbietern sind:
        renderProviderList(currentFilterId); 
    } else {
        // Wenn wir bei den Events sind (deine bestehende Logik):
        const sourceData = (typeof dynamicEvents !== 'undefined' && dynamicEvents.length > 0) ? dynamicEvents : (typeof lastKnownEvents !== 'undefined' ? lastKnownEvents : []);
        let filteredEvents = sourceData;

        if (currentFilterId !== null) {
            filteredEvents = sourceData.filter(event => event.providerId === currentFilterId);
        }
        
        // Suche einbeziehen...
        const searchTerm = (typeof searchInput !== 'undefined') ? searchInput.value.toLowerCase() : "";
        if (searchTerm) {
            filteredEvents = filteredEvents.filter(event => 
                event.title.toLowerCase().includes(searchTerm) ||
                event.description.toLowerCase().includes(searchTerm)
            );
        }
        renderEventList(filteredEvents); 
    }
}

function handleRefresh() {
    contentDiv.innerHTML = '';
    appLoader.style.display = 'block';
    headerTitle.textContent = "Aktualisiere..."; 
    currentFilterId = null;
    if(typeof searchInput !== 'undefined') searchInput.value = '';
    fetchCalendarEvents(); 
    switchView('events');
}

function renderProviderList(filterId = null) {
    if (typeof contentDiv === 'undefined' || !contentDiv) return;
    contentDiv.innerHTML = '';
    
    let filteredProviders = [...providers]; 
    if (filterId !== null) {
        filteredProviders = filteredProviders.filter(p => Number(p.id) === Number(filterId));
    }

    filteredProviders.sort((a, b) => a.id - b.id);

    // --- EINHEITLICHE ICONS DEFINIEREN ---
    const iconBaseStyle = 'width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"';
    const mailIconSVG = `<svg ${iconBaseStyle} viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;
    const phoneIconSVG = `<svg ${iconBaseStyle} viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.81 12.81 0 0 0 .63 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.63A2 2 0 0 1 22 16.92z"></path></svg>`;
	const calendarIconSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;

    // Hilfsfunktion für den Icon-Kreis (Badge)
    const wrapIcon = (svg) => `<span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #f0f0f0; border-radius: 50%; color: #555; flex-shrink: 0;">${svg}</span>`;

    filteredProviders.forEach(provider => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-provider-id', provider.id);
        
        const pColor = provider.color || '#8B4513';
        card.style.borderLeft = `10px solid ${pColor}`;
        
        let contactHTML = 'Keine Angabe';
        const rawContact = provider.contact || '';
        const linkColor = "#004a99"; 

        if (rawContact) {
            const commonLinkStyle = `color: ${linkColor}; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 10px;`;
            
            if (rawContact.includes('@')) {
                const subject = encodeURIComponent(`Anfrage an ${provider.name}`);
                contactHTML = `<a href="mailto:${rawContact}?subject=${subject}" target="_blank" rel="noopener" style="${commonLinkStyle}">
                                    ${wrapIcon(mailIconSVG)} <span style="text-decoration: underline;">${rawContact}</span>
                               </a>`;
            } else if (/[0-9]/.test(rawContact)) {
                const cleanNumber = rawContact.replace(/[^0-9+]/g, '');
                contactHTML = `<a href="tel:${cleanNumber}" style="${commonLinkStyle}">
                                    ${wrapIcon(phoneIconSVG)} <span style="text-decoration: underline;">${rawContact}</span>
                               </a>`;
            } else {
                contactHTML = rawContact;
            }
        }

        card.innerHTML = `
            <div class="card-content" style="padding: 15px;">
                <h3 style="margin: 0 0 12px 0; color: #333; font-size: 1.25em; font-family: sans-serif;">${provider.name}</h3>
                <div style="margin: 8px 0;">${contactHTML}</div>
                ${provider.info ? `<p style="margin: 12px 0 0 0; color: #666; font-size: 0.9em; line-height: 1.5; white-space: pre-line;">${provider.info}</p>` : ''}
            </div>
        `;
        
        card.onclick = (e) => {
            if (e.target.closest('a')) return;
            if (typeof showVeranstalterDetails === 'function') {
                showVeranstalterDetails(provider.id);
            }
        };
        
        contentDiv.appendChild(card);
    });
}

function renderProviderListFiltered(listToRender) {
    if (!contentDiv) return;
    contentDiv.innerHTML = '';
    
    listToRender.forEach(provider => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.borderLeft = `10px solid ${provider.color || '#ccc'}`;
        card.innerHTML = `
            <div class="card-content">
                <h3 style="margin: 0 0 8px 0; color: #8B4513;">${provider.name}</h3>
                <p style="margin: 4px 0;"><strong>Kontakt:</strong> ${provider.contact || 'Keine Angabe'}</p>
                <p style="margin: 4px 0; font-size: 0.9em;">${provider.info || ''}</p>
            </div>
        `;
        card.onclick = () => showVeranstalterDetails(provider.id);
        contentDiv.appendChild(card);
    });
}

// --- 5. FUNKTIONEN ZUM ANZEIGEN DER DETAILS (MIT KALENDER-LOGIK) ---
function showEventDetails(event) {
    if (!event) return; 

    // Cache für die shareEvent() und downloadICS() Funktionen
    window.eventDetailsCache = event;

    const provider = providers.find(p => p.id == event.providerId);
    const providerName = provider ? provider.name : "Unbekannter Anbieter";
    const providerColor = provider ? provider.color : '#8B4513';
    const safeLinkColor = '#8B4513';

    const eventModal = document.getElementById('eventModal');
    const modalContent = eventModal.querySelector('.modal-content');
    
    if (modalContent) {
        modalContent.style.borderLeft = `10px solid ${providerColor}`;
        modalContent.style.paddingLeft = "20px";
    }

    const originalDescription = event.description || "";
    const imageUrl = getEmbeddableDriveLink(originalDescription);
    let cleanedDescription = originalDescription;
    const fullLinkRegex = /https:\/\/drive\.google\.com\/(?:file\/d\/|open\?id=)[a-zA-Z0-9_-]+(?:[^ \n\r]*)/g;
    
    if (imageUrl && originalDescription) {
        cleanedDescription = originalDescription.replace(fullLinkRegex, '').trim();
    }
    
    const imageHtml = imageUrl
        ? `<div class="event-image-container" style="margin-bottom: 15px;"><img src="${imageUrl}" alt="Event Anhang" class="event-image" style="width: 100%; border-radius: 8px;"></div>`
        : '';

    let timeDisplay;
    const rawDate = event.date || ""; 
    let dateOnly = rawDate.split(' um')[0].split(',')[0].trim();
    const timeMatch = rawDate.match(/(\d{2}:\d{2})/);
    const startTime = timeMatch ? timeMatch[0] : "";

    if (startTime) {
        if (event.endDate && event.endDate !== startTime) {
            timeDisplay = `Am ${dateOnly} von ${startTime} bis ${event.endDate} Uhr`;
        } else {
            timeDisplay = `Am ${dateOnly} um ${startTime} Uhr`;
        }
    } else {
        timeDisplay = `${rawDate} (Ganztägig)`;
    }
        
    const locationEncoded = encodeURIComponent(event.location || "");
    const locationLink = `<a href="https://maps.google.com/?q=${locationEncoded}" target="_blank" style="color: ${safeLinkColor}; font-weight: bold;">${event.location || "Keine Ortsangabe"} (Auf Karte anzeigen)</a>`;

    const googleCalendarUrl = getGoogleCalendarUrl(event); 
    
    Array.from(modalContent.children).forEach(child => {
        if (!child.classList.contains('close')) child.remove();
    });

    const finalDescription = cleanedDescription || "Keine weitere Beschreibung vorhanden.";
    
    const titleUpper = (event.title || "").toUpperCase();
    const isCancelled2 = titleUpper.includes("ABGESAGT") || titleUpper.includes("FÄLLT AUS");
    const isMoved2 = titleUpper.includes("VERSCHOBEN");
    const isChanged2 = titleUpper.includes("ÄNDERUNG");
    const isNew = titleUpper.includes("NEU");
    
    const displayTitle2 = (event.title || "")
		.replace(/ABGESAGT[:]?/i, '')
		.replace(/FÄLLT AUS[:]?/i, '')
		.replace(/VERSCHOBEN[:]?/i, '')
		.replace(/ÄNDERUNG[:]?/i, '')
		.replace(/NEU[:]?/i, '')
		.replace(/\(ID[:]?\s*\d+\)/i, '') // <-- Diese Zeile entfernt (ID:3), (ID: 3) etc.
		.trim();

    let statusBoxHtml = '';
    if (isCancelled2) {
        statusBoxHtml = `<div style="background: #d93025; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; margin-top: 20px;">⚠️ DIESER TERMIN FÄLLT AUS!</div>`;
    } else if (isMoved2) {
        statusBoxHtml = `<div style="background: #ffc107; color: #856404; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 1px solid #ff9800; margin-top: 20px;">📅 TERMIN VERSCHOBEN!</div>`;
    } else if (isChanged2) {
        statusBoxHtml = `<div style="background: #2196F3; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; margin-top: 20px;">ℹ️ ÄNDERUNG BEACHTEN!</div>`;
    } else if (isNew) {
        statusBoxHtml = `<div style="background: #4CAF50; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; margin-top: 20px;">✨ NEUER TERMIN!</div>`;
    }

    // --- PIXEL-PERFEKTES BUTTON SYSTEM ---
    const btnStyle = "display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; height: 48px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; color: white !important; text-decoration: none; box-sizing: border-box; font-family: sans-serif;";
    
    const iconBase = 'width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"';
    const googleIcon = `<svg ${iconBase} viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
    const icsIcon = `<svg ${iconBase} viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`;
    const shareIcon = `<svg ${iconBase} viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`;

    const detailsHTML = `
        ${statusBoxHtml}
        <h2 style="color: #8B4513; margin-top: 10px; ${isCancelled2 ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${displayTitle2}</h2>
        ${imageHtml}
        <p><strong>Wann:</strong> ${timeDisplay}</p>
        <p><strong>Wo:</strong> ${locationLink}</p>
        <hr style="border-top: 1px solid #eee; margin: 15px 0;">
        <p><strong>Anbieter:</strong> <strong style="color: ${safeLinkColor}; cursor: pointer;" onclick="showVeranstalterDetails(${event.providerId})">${providerName} (Details)</strong></p>
        <h3 style="margin-top: 20px;">Beschreibung:</h3>
        <p>${finalDescription.replace(/\n/g, '<br>')}</p>
        
        <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px; display: flex; flex-direction: column; gap: 10px;">
            ${!isCancelled2 ? `
                <a href="${googleCalendarUrl}" target="_blank" style="${btnStyle} background-color: #4285F4;">
                    ${googleIcon} In Google Kalender
                </a>
                <button onclick="downloadICS(window.eventDetailsCache)" style="${btnStyle} background-color: #6c757d;">
                    ${icsIcon} .ics Datei laden
                </button>
            ` : `
                <div style="padding: 15px; background: #fff8e1; border: 1px solid #ffc107; border-radius: 8px; display: flex; align-items: flex-start; gap: 12px;">
                    <span style="font-size: 1.5em;">ℹ️</span>
                    <div style="color: #856404; font-size: 0.95em; line-height: 1.4;">
                        <strong>Wichtiger Hinweis:</strong><br>
                        Solltest du diesen Termin bereits gespeichert haben, lösche ihn bitte manuell aus deinem Kalender.
                    </div>
                </div>
            `}
            <button onclick="shareEvent()" style="${btnStyle} background-color: #28a745;">
                ${shareIcon} Event teilen
            </button>
        </div>
    `;
    
    modalContent.insertAdjacentHTML('beforeend', detailsHTML);
    eventModal.style.display = "block";
}

// --- BASIS-FUNKTIONEN FÜR MODALS ---

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = "none";
    }
}

function showVeranstalterDetails(providerId) {
    closeModal('eventModal'); 

    const provider = providers.find(p => p.id === providerId);
    if (!provider) {
        console.error("Anbieter nicht gefunden:", providerId);
        return;
    }

    const veranstalterModal = document.getElementById('veranstalterModal');
    const modalContentBox = veranstalterModal.querySelector('.modal-content') || veranstalterModal;
    
    if (modalContentBox) {
        modalContentBox.style.borderLeft = `10px solid ${provider.color || '#8B4513'}`;
        modalContentBox.style.paddingLeft = "20px";
    }

    document.getElementById('modalProviderName').textContent = provider.name;
    
    // --- EINHEITLICHES ICON-SYSTEM (SVG) ---
    const iconBaseStyle = 'width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"';
    const mailIconSVG = `<svg ${iconBaseStyle} viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;
    const phoneIconSVG = `<svg ${iconBaseStyle} viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.81 12.81 0 0 0 .63 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.63A2 2 0 0 1 22 16.92z"></path></svg>`;

    const wrapIcon = (svg) => `<span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #f0f0f0; border-radius: 50%; color: #444; flex-shrink: 0;">${svg}</span>`;

    const contactContainer = document.getElementById('modalProviderContact');
    let contactHTML = 'Keine Angabe';
    const rawContact = provider.contact || '';
    const linkColor = "#004a99";

    if (rawContact) {
        const commonStyle = `color: ${linkColor}; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 12px; margin-bottom: 5px;`;
        
        if (rawContact.includes('@')) {
            const subject = encodeURIComponent(`Anfrage an ${provider.name}`);
            contactHTML = `<a href="mailto:${rawContact}?subject=${subject}" target="_blank" rel="noopener" style="${commonStyle}">
                            ${wrapIcon(mailIconSVG)} <span style="text-decoration: underline;">${rawContact}</span>
                           </a>`;
        } else if (/[0-9]/.test(rawContact)) {
            const cleanNumber = rawContact.replace(/[^0-9+]/g, '');
            contactHTML = `<a href="tel:${cleanNumber}" style="${commonStyle}">
                            ${wrapIcon(phoneIconSVG)} <span style="text-decoration: underline;">${rawContact}</span>
                           </a>`;
        } else {
            contactHTML = rawContact;
        }
    }
    contactContainer.innerHTML = contactHTML;

    const infoElement = document.getElementById('modalProviderInfo');
    infoElement.textContent = provider.info || 'Keine weiteren Informationen.';
    infoElement.style.whiteSpace = "pre-line";

    const linkElement = document.getElementById('modalProviderLink');
    if (provider.link) {
        linkElement.href = provider.link;
        linkElement.style.display = 'inline-block';
        linkElement.style.marginTop = '15px';
    } else {
        linkElement.style.display = 'none';
    }

    if (veranstalterModal) {
        veranstalterModal.style.display = "block";
    }
}

// --- 6. NAVIGATION UND START (VOLLSTÄNDIG & REPARIERT) ---

function filterEvents() {
    const sInput = document.getElementById('searchInput');
    if (!sInput) return;
    
    const searchTerm = sInput.value.toLowerCase().trim();

    // FALL 1: Wir sind auf der Anbieter-Seite
    if (currentView === 'providers') {
        const filteredProviders = providers.filter(p => {
            if (p.id === 99) return false; // "Freie Anbieter" ignorieren
            return p.name.toLowerCase().includes(searchTerm) || 
                   (p.info && p.info.toLowerCase().includes(searchTerm));
        });
        
        // Wir nutzen eine kleine Hilfsfunktion zum Rendern der gefilterten Anbieter
        renderProviderListFiltered(filteredProviders);

    // FALL 2: Wir sind auf der Termin-Seite (dein bisheriger Code)
    } else {
        const sourceData = (typeof dynamicEvents !== 'undefined' && dynamicEvents.length > 0) 
                           ? dynamicEvents 
                           : (typeof lastKnownEvents !== 'undefined' ? lastKnownEvents : []);

        const filteredEvents = sourceData.filter(event => {
            const provider = providers.find(p => p.id == event.providerId);
            const providerName = provider ? provider.name.toLowerCase() : '';
            return (event.title || "").toLowerCase().includes(searchTerm) ||
                   (event.location || "").toLowerCase().includes(searchTerm) ||
                   providerName.includes(searchTerm);
        });

        if (typeof renderEventList === 'function') {
            renderEventList(filteredEvents);
        }
    }
}

async function shareEvent() {
    const event = window.eventDetailsCache;
    if (!event) return;

    // Wir erstellen einen Link, der die ID des Events enthält
    const shareUrl = `${window.location.origin}${window.location.pathname}?eventid=${event.id}`;
    
    const shareText = `🗓️ *${event.title}*\n` +
                      `Wann: ${event.date}\n\n` +
                      `Hier alle Details ansehen:`;

    if (navigator.share) {
        await navigator.share({ title: event.title, text: shareText, url: shareUrl });
    } else {
        window.open(`https://wa.me/?text=${encodeURIComponent(shareText + " " + shareUrl)}`, '_blank');
    }
}

function hideAllViews() {
    if (typeof contentDiv !== 'undefined') contentDiv.style.display = 'none';
    if (typeof whatsappView !== 'undefined') whatsappView.style.display = 'none';
    if (typeof contactView !== 'undefined') contactView.style.display = 'none';
    if (typeof filterContainer !== 'undefined') filterContainer.style.display = 'none';
    
    const sContainer = document.getElementById('search-container');
    if (sContainer) sContainer.style.display = 'none';
}

function switchView(view) {
    currentView = view; // Hier speichern wir die aktuelle Ansicht
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    hideAllViews();
    
    const sContainer = document.getElementById('search-container');
    const sInput = document.getElementById('searchInput');

    if (view === 'events') {
        document.getElementById('events-btn').classList.add('active');
        headerTitle.textContent = "Veranstaltungen";
        contentDiv.style.display = 'block';
        if (sContainer) sContainer.style.display = 'block';
        if (sInput) sInput.style.display = 'block';
		if (typeof filterContainer !== 'undefined') filterContainer.style.display = 'block'; 
			createFilterButtons(); // Neu hinzugefügt, um "Alle Events" zu zeigen
		if (typeof applyCategoryFilter === 'function') applyCategoryFilter(currentFilterId);

    } else if (view === 'providers') {
        document.getElementById('providers-btn').classList.add('active');
        headerTitle.textContent = "Anbieter";
        contentDiv.style.display = 'block';

        // HIER: Suche und Bubbles wieder sichtbar machen
        if (sContainer) sContainer.style.display = 'block';
        if (sInput) sInput.style.display = 'block';
        
		if (typeof filterContainer !== 'undefined' && filterContainer) {
			filterContainer.style.display = 'block';
		}
		createFilterButtons(); // Neu hinzugefügt, um "Alle Anbieter" zu zeigen
		if (typeof renderProviderList === 'function') {
			renderProviderList(currentFilterId); 
		}

        // Liste zeichnen
        if (typeof renderProviderList === 'function') {
            renderProviderList(currentFilterId); 
        }

    } else if (view === 'whatsapp') {
        document.getElementById('whatsapp-btn').classList.add('active');
        headerTitle.textContent = "WhatsApp";
        if (whatsappView) whatsappView.style.display = 'block';
        
    } else if (view === 'contact') {
        document.getElementById('contact-btn').classList.add('active');
        headerTitle.textContent = "Feedback & Impressum"; 
        if (contactView) contactView.style.display = 'block';
    }
}

window.onload = () => {
    // 1. Splash Screen & Logo
    if (typeof getSplashLogoPath === 'function') {
        const logoData = getSplashLogoPath();
        const splashLogo = document.querySelector('#splashScreen .splash-logo');
        if (splashLogo) {
            const splashText = document.querySelector('#splashScreen p');
            if (splashText) splashText.textContent = logoData.text;
            splashLogo.src = logoData.path;
            splashLogo.alt = "Splash Logo";
        }
    }

    // 2. Daten laden
    if (typeof fetchCalendarEvents === 'function') fetchCalendarEvents();
    if (typeof injectVersionNumber === 'function') injectVersionNumber();
    
    // 3. Navigation Buttons binden
    const btnEvents = document.getElementById('events-btn');
    const btnProviders = document.getElementById('providers-btn');
    const btnWhatsapp = document.getElementById('whatsapp-btn');
    const btnContact = document.getElementById('contact-btn');

    if (btnEvents) btnEvents.onclick = () => switchView('events');
    if (btnProviders) btnProviders.onclick = () => switchView('providers');
    if (btnWhatsapp) btnWhatsapp.onclick = () => switchView('whatsapp');
    if (btnContact) btnContact.onclick = () => switchView('contact');
    
    // 4. Refresh Button
    const refBtn = document.getElementById('refreshButton');
    if (refBtn) {
        refBtn.onclick = (typeof handleRefresh === 'function') ? handleRefresh : () => location.reload();
    }

    // 5. Suche binden - HIER WIRD SEARCHINPUT DEFINIERT
    const sInput = document.getElementById('searchInput');
    if (sInput && typeof filterEvents === 'function') {
        sInput.addEventListener('input', filterEvents);
        console.log("Suche erfolgreich verknüpft.");
    } else {
        console.error("Suche konnte nicht gestartet werden: searchInput Feld fehlt im HTML.");
    }
};

window.onclick = function(event) {
    const evModal = document.getElementById('eventModal');
    const provModal = document.getElementById('veranstalterModal');
    if (event.target == evModal) evModal.style.display = "none";
    if (event.target == provModal) provModal.style.display = "none";
}
    
	if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/mnn-event-app/sw.js', {
            scope: '/mnn-event-app/' // Wichtig: Der Scope muss auch korrigiert werden
        })
        .then(registration => {
            console.log('ServiceWorker registriert mit Scope:', registration.scope);
        })
        .catch(error => {
            console.error('ServiceWorker Registrierung fehlgeschlagen:', error);
        });
    });
}

function checkForDeepLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventid');

    if (eventId && typeof lastKnownEvents !== 'undefined' && lastKnownEvents.length > 0) {
        const targetEvent = lastKnownEvents.find(e => String(e.id) === String(eventId));
        if (targetEvent) {
            console.log("Deep-Link Treffer:", targetEvent.title);
            showEventDetails(targetEvent);
            // URL säubern ohne die Seite neu zu laden
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
}

</script>
</body>

</html>