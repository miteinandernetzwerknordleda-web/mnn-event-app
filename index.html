<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lokale Events App</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
* {
    box-sizing: border-box; 
}
/* 1. GLOBALE STILE */

    #splashScreen {
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f4f7f6; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        z-index: 9999; 
        color: #8B4513; 
        font-size: 1.2em;
        text-align: center;
        transition: opacity 1s ease-out; 
    }

    #splashScreen.fade-out {
        opacity: 0;
        pointer-events: none; 
    }

	.splash-logo {
        max-width: 400px;
        height: auto;
        margin-bottom: 20px;
        border-radius: 15px; 
    }	
	
    #splashScreen h1 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.8em;
    }

    #splashScreen p {
        font-style: italic;
        color: #666;
    }
    
    /* Copyright Styling */
    #splash-copyright {
        position: absolute; 
        bottom: 20px; 
        width: 100%;
        text-align: center;
        font-size: 0.8em;
        color: #666;
    }


    body {
        font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7f6;
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
        overflow-x: hidden;
    }

	.spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #8B4513; 
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto; 
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

/* 2. HEADER UND CONTAINER */

    #app-container {
        max-width: 600px;
        width: 100%;
        margin: 0 auto;
        padding-bottom: 80px;
        flex-grow: 1;
        background-color: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }

    #app-header { 
        background-color: #8B4513;
        color: white;
        padding: 10px 20px; 
        display: flex; 
        align-items: center; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #app-logo {
        height: 40px; 
        width: auto;
        margin-right: 15px; 
        vertical-align: middle; 
    }
    
    #headerTitle { 
        margin: 0;
        padding: 0;
        font-size: 1.5em; 
        font-weight: bold;
        color: white;
        flex-grow: 1; 
        text-align: left; 
    }
    
    /* Styling für den Refresh Button */
    #refreshButton {
        background: none;
        border: 1px solid white; 
        color: white;           /* WICHTIG: Macht das Symbol weiß */
        font-size: 1.4em; 
        cursor: pointer;
        padding: 5px 10px;
        margin-left: 15px;
        border-radius: 5px;
        transition: background-color 0.2s;
        line-height: 1; 
    }

    #refreshButton:hover {
        background-color: #A0522D; 
    }
    #refreshButton:active {
        background-color: #694429; 
    }
    /* ENDE Refresh Styling */

	#search-container {
        max-width: 600px;
        width: 100%;
        padding: 10px 20px;
        background-color: #f4f7f6; 
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        z-index: 5;
    }

    #searchInput {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 20px; 
        font-size: 1em;
        box-sizing: border-box; 
        transition: border-color 0.3s;
    }

    #searchInput:focus {
        outline: none;
        border-color: #8B4513; 
        box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.2);
    }

/* --- KATEGORIE-FILTER-STILE (Aktiviert) --- */
#filter-container {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    padding: 0 20px 10px; 
    background-color: #f4f7f6;
    overflow-x: auto; 
    white-space: nowrap; 
    -webkit-overflow-scrolling: touch; 
}

.filter-btn {
    display: inline-block;
    padding: 5px 10px;
    margin-right: 8px;
    border: 1px solid #ccc;
    border-radius: 15px;
    background-color: white;
    font-size: 0.85em;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    color: #333;
    font-weight: 500;
}

.filter-btn:hover {
    background-color: #eee;
}

.filter-btn.selected {
    background-color: #8B4513;
    color: white;
    border-color: #8B4513;
    font-weight: bold;
}
/* --- ENDE KATEGORIE-FILTER-STILE --- */


/* 3. KARTEN-STIL */
    .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd; 
        border-left: 10px solid #007bff; 
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

	.card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1),
                    0 0 0 2px var(--event-color);
    }

    .card h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #8B4513;
        font-size: 1.1em;
    }

    .card p {
        margin: 4px 0;
        font-size: 0.9em;
        color: #000000;
    }
    
    /* NEUER STIL FÜR MONATSTRENNUNG */
    .month-separator {
        background-color: #e8e8e8; /* Hintergrundfarbe des Trenners */
        color: #8B4513;            /* Braune Textfarbe */
        padding: 10px 20px;
        margin: 10px 0 0;
        font-size: 1.2em;
        font-weight: bold;
        position: sticky;          /* Wichtig: Lässt den Header kleben */
        top: 60px;                 /* Soll unter dem Haupt-Header (ca. 60px Höhe) kleben */
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Anpassung der Karten-Abstände */
    #app-content .card {
        margin: 15px 20px; /* Kartenabstand für die Trennung */
    }

    /* NEUER STIL FÜR KALENDER-BUTTONS */
.calendar-buttons {
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    text-align: center;
    /* Container auf volle Breite des Modals setzen */
    display: flex;
    flex-direction: column; 
    gap: 10px; /* Abstand zwischen den Buttons */
}

.calendar-link-btn {
    display: block; 
    width: 100%; /* Beide Buttons nehmen volle Container-Breite ein */
    
    /* Konsistente Farbgebung */
    background-color: #A0522D; /* Dunklere Variante Ihres Brauns */
    color: white;
    
    padding: 12px;
    margin: 0; /* Margin im Container durch gap ersetzt */
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    transition: background-color 0.2s;
    font-size: 1em;
    border: none;
    cursor: pointer;
}

.calendar-link-btn:hover {
    background-color: #694429; /* Noch dunkler beim Hover */
    opacity: 1; /* Überschreibe das generische opacity: 0.9 */
}


/* 3. KARTEN-STIL (Ergänzung für Datum & Abstand) */
    
    .card-content {
        flex-grow: 1;
        padding-left: 20px;
    }

    .date-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 40px;
        margin-right: 0px;
        color: #333;
        padding-top: 5px;
    }

	.date-day-num {
        font-size: 1.8em;
        font-weight: 700;
        line-height: 1;
        color: #8B4513;
    }

    .date-day-short {
        margin-top: 12px;
        font-size: 1.2em;
        font-weight: 600;
        text-transform: uppercase;
        line-height: 1;
    }

    /* 4. NAVIGATION */
    #navigation {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 600px;
        margin: 0 auto;
        /* HIER: Vier Buttons in der Leiste */
        display: flex;
        background-color: #343a40; 
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        z-index: 20;
    }

    .nav-btn {
        flex: 1;
        padding: 15px 5px; /* Etwas weniger Padding für 4 Buttons */
        color: white;
        text-align: center;
        text-decoration: none;
        font-size: 0.9em; /* Etwas kleinere Schrift */
        cursor: pointer;
        transition: background-color 0.3s;
        border-radius: 0;
        border: none;
        background: none;
        line-height: 1.1; 
    }

    .nav-btn:hover {
        background-color: #495057;
    }

    .nav-btn.active {
        background-color: #8B4513;
        font-weight: bold;
    }

/* 5. MODAL-STIL */

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 25px; 
        border-radius: 10px;
        width: 90%;
        max-width: 580px; 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation-name: animatetop;
        animation-duration: 0.4s
    }

    @keyframes animatetop {
        from {top: -300px; opacity: 0}
        to {top: 15%; opacity: 1}
    }
    
    .close {
        color: #555;
        float: right; 
        font-size: 36px; 
        font-weight: 300;
        line-height: 1;
        margin-top: -10px; 
        margin-right: -5px; 
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

/* 6. RESPONSIVE ANPASSUNGEN (für kleinere Bildschirme) */
    @media (max-width: 600px) {
        #app-container {
            padding-bottom: 70px;
        }
        #navigation {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
	.modal-content {
        background-color: #fefefe;
        margin: 10% auto; 
        padding: 20px;
        border: 1px solid #888;
        border-radius: 10px;
        width: 90%;
        max-width: 580px; 
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
	
/* 6. MODAL STIL (Ergänzung für Bilder) */

    .event-image-container {
        text-align: center; 
        margin: 15px auto; 
        max-width: 100%; 
        border-radius: 5px;
        overflow: hidden;
        height: auto;
    }

    .event-image {
        max-width: 100%;
        width: 100%; 
        height: auto;
        display: block;
        min-height: 50px;
        border: none;
    }
	
    }

/* Zusätzliches Styling für die neuen Seiten-Container */
.static-view {
    padding: 20px;
    display: none; /* Standardmäßig versteckt */
    font-size: 1.1em;
}
.static-view h2 {
    color: #8B4513;
    border-bottom: 2px solid #8B4513;
    padding-bottom: 5px;
}
.static-view h3 {
    color: #8B4513;
}
.static-view a {
    color: #007bff;
    font-weight: bold;
    text-decoration: none;
}
.static-view a:hover {
    text-decoration: underline;
}

</style>
</head>
<body>

<div id="splashScreen">
    <img src="logo.png" alt="Miteinander Netzwerk Nordleda Logo" class="splash-logo">
    <h1>
        EventApp
    </h1>
    <p>Lade Events...</p>
    <div id="splash-copyright">
        (c) 2025 Miteinander Netzwerk Nordleda
    </div>
</div>

<div class="container">
<header id="app-header">
    <div id="logo-container">
        <img id="app-logo" src="logo.png" alt="Vereins Logo">
    </div>
    <h1 id="headerTitle">Veranstaltungen</h1>
    <button id="refreshButton">↻</button> 
</header>

<div id="search-container">
    <input type="text" id="searchInput" placeholder="Events, Anbieter oder Ort suchen...">
</div>

<div id="filter-container" style="display: none;">
    </div>
<div id="app-loader" style="text-align: center; padding-top: 50px; display: none;">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #666;">Veranstaltungen werden geladen...</p>
</div>

    <div id="app-content" style="padding-bottom: 70px;">
    </div>
    
    <div id="whatsapp-view" class="static-view">
        
        <h2>WhatsApp Community</h2>
        <p>Tritt unserer Community bei, um um in verschiedenen Gruppen nach Lust und Laune über alles mögliche in unserem Nordleda zu chatten. Und wenn es eine Idee gibt, die unbedingt besprochen werden sollte, dann erstellt ihr selber eine Gruppe.<br>
			Reinschauen, Mitmachen, Diskutieren, Moderieren.</p>
        <div style="margin-top: 20px; text-align: center;">
            <a href="https://chat.whatsapp.com/JYa2h2T2EynJSRo2KApNiE" target="_blank" style="display: inline-block; background-color: #25D366; color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-size: 1.2em;">
                Community beitreten
            </a>
        </div>

        <hr style="margin: 40px 0; border-top: 1px solid #ddd;">
        
        <h2>WhatsApp Kanal für Veranstaltungen</h2>
        <p>Abonniert  unseren Kanal, um aktuelle Neuigkeiten, kurzfristige Informationen und Ankündigungen direkt auf euer Handy zu erhalten.<br>
		Dieser Kanal dient nur der Information durch uns.</p>
        <div style="margin-top: 20px; text-align: center;">
            <a href="https://whatsapp.com/channel/0029VbBsgtIK0IBZMmtQJ61J" target="_blank" style="display: inline-block; background-color: #25D366; color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-size: 1.2em;">
                Kanal abonnieren
            </a>
        </div>
        
    </div>

    <div id="contact-view" class="static-view">
        
        <h2>Feedback, Anfragen & Support</h2>
        <p>Habet ihr allgemeine Fragen, möchtet ihr eine Veranstaltung melden oder benötigt ihr technischen Support für diese App?</p>
        <p>Bitte nutzt unsere zentrale E-Mail-Adresse.</p>
        
        <h3 style="color: #8B4513;">Zentrale Kontaktstelle:</h3>
        <div style="margin-top: 20px; margin-bottom: 40px;">
            E-Mail: <a href="mailto:miteinander.netzwerk.nordleda@gmail.com">miteinander.netzwerk.nordleda@gmail.com</a>
        </div>
        
        <hr style="margin: 40px 0; border-top: 1px solid #ddd;">
        
        <h2>Impressum</h2>
        <p><strong>Betreiber und Verantwortlich für den Inhalt:</strong></p>
        <p>
            Interessengruppe<br>
			Miteinander Netzwerk Nordleda<br>
            c/o Andreas Beckmann<br>
            Kampen 31 - 21765 Nordleda
        </p>

        <h3 style="color: #8B4513; margin-top: 25px;">Verantwortlich im Sinne des Presserechts (V.i.S.d.P.):</h3>
        <p>
            Andreas Beckmann<br>
            Kampen 31 - 21765 Nordleda
        </p>

        <h3 style="color: #8B4513; margin-top: 25px;">Kontakt:</h3>
        <p>
            E-Mail: <a href="mailto:miteinander.netzwerk.nordleda@gmail.com">miteinander.netzwerk.nordleda@gmail.com</a>
        </p>
        <p style="font-size: 0.9em; margin-top: 20px;">
            *Hinweis:* Wir sind bemüht, die Informationen in dieser App aktuell und korrekt zu halten. Da die App ausschließlich zur Bekanntmachung von lokalen Veranstaltungen dient, übernehmen wir keine Haftung für die Richtigkeit der Termine und Inhalte der Veranstalter.
        </p>
    </div>
    <div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('eventModal')">×</span>
        </div>
</div>

<div id="veranstalterModal" class="modal">
    <div class="modal-content" id="veranstalterDetail">
        <span class="close" onclick="closeModal('veranstalterModal')">×</span>
        
        <h3 id="modalProviderName"></h3>
        <p><strong>Kontakt:</strong> <span id="modalProviderContact"></span></p>
        <p><strong>Info:</strong> <span id="modalProviderInfo"></span></p>
        <a id="modalProviderLink" href="#" target="_blank" style="color: #8B4513;">Zur Webseite</a>
        </div>
</div>
    
    <nav id="navigation">
        <button id="events-btn" class="nav-btn active" onclick="switchView('events')">Veranstaltungen</button>
        <button id="providers-btn" class="nav-btn" onclick="switchView('providers')">Anbieter</button>
        <button id="whatsapp-btn" class="nav-btn" onclick="switchView('whatsapp')">WhatsApp</button>
        <button id="contact-btn" class="nav-btn" onclick="switchView('contact')">Kontakt</button>
    </nav>
	
</div>


<script>
    // --- 1. KONFIGURATION ---
    const API_KEY = 'AIzaSyDDsCuRzCYH-U3tjoTu1VCiv641zY7K4Cc';
    const CALENDAR_ID = 'miteinander.netzwerk.nordleda@gmail.com';
    const MIN_SPLASH_DURATION = 4000; 
    
    // Basisdaten für die Anbieter
    const providers = [
        { id: 1, name: "TSV Nordleda", contact: "Jürgen Hoberg Tel. 04758-546", info: "Der lokale Sportverein mit verschiedenen Angeboten", link: "https://www.nordleda.de/vereine-und-choere/tsv-nordleda-ev/", color: "#a4bdfc" },
        { id: 2, name: "DRK Nordleda", contact: "Anja von Bebern Tel. 04758-679", info: "Der DRK Ortsverein bietet mit dem Arbeitskreis viele verschiedene Veranstaltungen", color: "#ff887c" },
        { id: 3, name: "Schützenverein Nordleda", contact: "Über das Kontaktformular auf der Webseite", info: "Schützenverein Nordleda von 1953 e.V.", link: "https://www.svnordleda.de/", color: "#7ae7bf" },
        { id: 4, name: "Kirchengemeinde Nordleda", contact: "meike.mueller-bilgenroth@evlka.de", info: "Die Kirchengemeinde St. Nicolai in Nordleda", link: "https://www.kk-ch.de/gemeinden/nordleda/", color: "#dbadff" },
		{ id: 5, name: "taktlos-Chor", contact: "Über das Kontaktformular auf der Webseite", info: "...der a cappella Männerchor", link: "https://www.gruppe-taktlos.de/", color: "#5484ed" },
		{ id: 6, name: "LoGos-Chor Nordleda", contact: "Gunda Knust Tel. 04758-326", info: "Lobpreis-Gospelchor", color: "#8A2BE2" },
		{ id: 7, name: "FamilienHaven Nordleda", contact: "Serina Naß Tel. 015256302291", info: "Delfi Kurse - Fachkraft für Beikost, Elternvorbereitung, Säuglingspflege, Achtsamkeit", link: "https://www.instagram.com/delfinordleda/", color: "#fbd75b" },
		{ id: 8, name: "Werbegemeinschaft Nordleda", contact: "Hans-Hermann Ropers Tel. 04758-444", info: "Werbegemeinschaft des Ortes Nordleda", color: "#ffacac" },
		{ id: 9, name: "CDU Nordleda", contact: "Hans-Hermann Ropers Tel. 04758-444", info: "CDU Ortsverband Nordleda", link: "https://www.cdu-land-hadeln.de/ortsverbaende/nordleda/", color: "#000000" },
		{ id: 10, name: "SoVD Neuenkirchen/Nordleda", contact: "Über das Kontaktformular auf der Webseite", info: "Sozialverband Deutschland", link: "https://www.sovd-cuxhaven.de/verband-990125?verbandid=991896&cHash=f253ff976383e4a74d925e676582cb7b", color: "#D3D3D3" },
		{ id: 11, name: "Miteinander Netzwerk Nordleda", contact: "miteinander.netzwerk.nordleda@gmail.com", info: "Interessengruppe zur Stärkung des Gemeinschaftsgefüges", link: "https://sites.google.com/view/netzwerknordleda/start", color: "#EE00EE" },
		{ id: 12, name: "Feuerwehr Nordleda", contact: "info@feuerwehr-nordleda.de", info: "Freiwillige Feuerwehr und Jugendfeuerwehr Nordleda", link: "https://www.instagram.com/ffw_nordleda/?hl=de", color: "#FF0000" },
		{ id: 99, name: "Freier Anbieter", contact: "Evtl. über die Veranstaltungsbeschreibung", info: "verschiedene Anbieter von Veranstaltungen", color: "#F8F8FF" }

    ];
	
	const contentDiv = document.getElementById('app-content');
    const headerTitle = document.getElementById('headerTitle');
	const searchInput = document.getElementById('searchInput');
    const eventModal = document.getElementById('eventModal');
    const veranstalterModal = document.getElementById('veranstalterModal');
	const appLoader = document.getElementById('app-loader');
	const splashScreen = document.getElementById('splashScreen');
    const filterContainer = document.getElementById('filter-container'); 
    
    // Neu hinzugefügt, um den Such-Container ausblenden zu können
    const searchContainer = document.getElementById('search-container'); 
    
    const whatsappView = document.getElementById('whatsapp-view');
    const contactView = document.getElementById('contact-view');

    let dynamicEvents = [];
    let currentFilterId = null; 
    let startTime; 
    window.eventDetailsCache = null; // Cache für ICS-Download

    // --- 2. HILFSFUNKTIONEN ---

    function extractProviderId(titleString) {
        if (!titleString) return null;
        const match = titleString.trim().match(/\(ID:(\d+)\)/i);
        return match ? parseInt(match[1]) : null;
    }
    
    function cleanTitle(titleString) {
        if (!titleString) return 'Unbekanntes Event';
        return titleString.replace(/\s*\(ID:\d+\)\s*/i, '').trim();
    }
    
function getEmbeddableDriveLink(description) {
    if (!description) return null;
    const fileIdRegex = /(?:file\/d\/|id=)([a-zA-Z0-9_-]+)/;
    const match = description.match(fileIdRegex);
    
    if (match && match[1]) {
        const fileId = match[1].trim();
        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w600`; 
    }
    return null;
}

// NEUE HILFSFUNKTIONEN FÜR KALENDER-BUTTONS
function formatToCalendarDateString(dateObject, isAllDay) {
    // Google Calendar URL und ICS verwenden das YYYYMMDD-Format für Ganztagesevents
    const year = dateObject.getFullYear();
    const month = ('0' + (dateObject.getMonth() + 1)).slice(-2);
    const day = ('0' + dateObject.getDate()).slice(-2);

    if (isAllDay) {
        return `${year}${month}${day}`; // YYYYMMDD
    } else {
        // YYYYMMDDTHHMMSS (Lokale Zeit)
        const hour = ('0' + dateObject.getHours()).slice(-2);
        const minute = ('0' + dateObject.getMinutes()).slice(-2);
        return `${year}${month}${day}T${hour}${minute}00`; 
    }
}


function getGoogleCalendarUrl(event) {
    const title = encodeURIComponent(event.title);
    const description = encodeURIComponent(event.description.replace(/\n/g, ' ')); 
    const location = encodeURIComponent(event.location);
    
    let isAllDay = event.endDate === ''; 
    let startMoment = new Date(event.sortDate); 
    let endMoment;

    // 1. Startzeitpunkt bestimmen
    if (isAllDay) {
        // All-Day: Start ist Mitternacht
        startMoment.setHours(0, 0, 0, 0); 
    } else {
        // Timed Event: Zeit aus event.date parsen (z.B. "20:00 Uhr")
        const timeMatch = event.date.match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0, 0);
        }
    }
    
    // 2. Endzeitpunkt bestimmen
    if (isAllDay) {
        // All-Day: Endet am nächsten Tag um Mitternacht (exklusiv)
        endMoment = new Date(startMoment);
        endMoment.setDate(endMoment.getDate() + 1);
    } else {
        // Timed Event: Endzeit aus event.endDate parsen (z.B. "22:00 Uhr")
        endMoment = new Date(startMoment);
        const endTimeMatch = event.endDate.match(/(\d{2}):(\d{2})/);
        if (endTimeMatch) {
            endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0, 0);
            
            // Falls Endzeit vor Startzeit liegt (über Mitternacht hinaus):
            if(endMoment.getTime() < startMoment.getTime()) {
                endMoment.setDate(endMoment.getDate() + 1);
            }
        } else {
            // Falls Endzeit fehlt: 1 Stunde Dauer
            endMoment.setHours(startMoment.getHours() + 1);
        }
    }

    // 3. Formatierung für URL
    let startFormatted = formatToCalendarDateString(startMoment, isAllDay);
    let endFormatted = formatToCalendarDateString(endMoment, isAllDay);
    
    const datesParam = `${startFormatted}/${endFormatted}`;

    const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${datesParam}&details=${description}&location=${location}&sf=true`;
    
    return calendarUrl;
}

function getICSContent(event) {
    const provider = providers.find(p => p.id == event.providerId);
    const organizer = provider ? `ORGANIZER;CN=${provider.name}:mailto:${provider.contact || 'noreply@nordleda.de'}` : '';

    // Datum- & Zeit-Objekte (gleiche Logik wie in getGoogleCalendarUrl)
    let isAllDay = event.endDate === ''; 
    let startMoment = new Date(event.sortDate); 
    let endMoment;

    if (isAllDay) {
        startMoment.setHours(0, 0, 0, 0); 
        endMoment = new Date(startMoment);
        endMoment.setDate(endMoment.getDate() + 1);
    } else {
        const timeMatch = event.date.match(/(\d{2}):(\d{2})/);
        if (timeMatch) {
            startMoment.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0, 0);
        }
        endMoment = new Date(startMoment);
        const endTimeMatch = event.endDate.match(/(\d{2}):(\d{2})/);
        if (endTimeMatch) {
            endMoment.setHours(parseInt(endTimeMatch[1]), parseInt(endTimeMatch[2]), 0, 0);
            if(endMoment.getTime() < startMoment.getTime()) {
                endMoment.setDate(endMoment.getDate() + 1);
            }
        } else {
            endMoment.setHours(startMoment.getHours() + 1);
        }
    }
    
    // ICS benötigt YYYYMMDDTHHMMSS im lokalen Format oder DTSTART;VALUE=DATE für all-day
    const icsFormatDate = (date) => {
        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        return `${year}${month}${day}`;
    };
    
    const icsFormatTime = (date) => {
        const hour = ('0' + date.getHours()).slice(-2);
        const minute = ('0' + date.getMinutes()).slice(-2);
        const second = ('0' + date.getSeconds()).slice(-2);
        return `T${hour}${minute}${second}`;
    }
    
    let icsStartLine;
    let icsEndLine;
    
    if (isAllDay) {
        // DTSTART;VALUE=DATE:YYYYMMDD
        icsStartLine = `DTSTART;VALUE=DATE:${icsFormatDate(startMoment)}`;
        // DTEND;VALUE=DATE:YYYYMMDD (exklusiv, also +1 Tag)
        icsEndLine = `DTEND;VALUE=DATE:${icsFormatDate(endMoment)}`; 
    } else {
        // DTSTART:YYYYMMDDTHHMMSS
        icsStartLine = `DTSTART:${icsFormatDate(startMoment)}${icsFormatTime(startMoment)}`;
        icsEndLine = `DTEND:${icsFormatDate(endMoment)}${icsFormatTime(endMoment)}`; 
    }


    const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//MiteinanderNetzwerkNordleda//EventApp//DE',
        'CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        `UID:${event.id}-${Date.now()}@nordleda.de`,
        `DTSTAMP:${new Date().toISOString().replace(/[-:]|\.\d{3}/g, '').slice(0, 15)}Z`,
        icsStartLine,
        icsEndLine,
        `SUMMARY:${event.title}`,
        // Description muss Zeilenumbrüche mit \n und andere Sonderzeichen maskieren
        `DESCRIPTION:${event.description.replace(/,/g, '\\,').replace(/\n/g, '\\n')}`,
        `LOCATION:${event.location.replace(/,/g, '\\,')}`,
        organizer,
        'END:VEVENT',
        'END:VCALENDAR'
    ].join('\n');

    return icsContent;
}

function downloadICS(event) {
    if (!event) return; 
    
    const icsContent = getICSContent(event);
    
    // Erstellt eine temporäre Blob-URL, um den Download auszulösen
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    // Ersetzt alle Nicht-Alphanumerischen Zeichen mit Unterstrich für den Dateinamen
    link.setAttribute('download', `${event.title.replace(/[^a-z0-9]/gi, '_').substring(0, 50)}.ics`); 
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
// ENDE NEUE HILFSFUNKTIONEN FÜR KALENDER-BUTTONS


// --- 3. DATENABRUF VON GOOGLE KALENDER ---

function fetchCalendarEvents() {
    startTime = Date.now(); 

    const hideSplash = () => {
        const elapsedTime = Date.now() - startTime;
        const remainingTime = MIN_SPLASH_DURATION - elapsedTime;

        if (remainingTime > 0) {
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 1000); 
            }, remainingTime);
        } else {
             splashScreen.classList.add('fade-out');
             setTimeout(() => {
                 splashScreen.style.display = 'none';
             }, 1000); 
        }
    };

    headerTitle.textContent = "Veranstaltungen";
    contentDiv.innerHTML = '';

    const threeMonthsFromNow = new Date();
    threeMonthsFromNow.setDate(threeMonthsFromNow.getDate() + 90);
    const timeMaxParam = threeMonthsFromNow.toISOString();

    const API_URL = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${API_KEY}&timeMin=${(new Date()).toISOString()}&timeMax=${timeMaxParam}&singleEvents=true&orderBy=startTime`;

    fetch(API_URL)
        .then(response => {
            if (!response.ok) {
                appLoader.style.display = 'none';
                hideSplash(); 
                throw new Error(`HTTP error! status: ${response.status}. API-Schlüssel oder Kalender-ID prüfen.`);
            }
            return response.json();
        })
        .then(data => {
            dynamicEvents = data.items.map((item, index) => {
                const rawTitle = item.summary || '';
                const providerId = extractProviderId(rawTitle);
                
                const isTimedEvent = !!item.start.dateTime;
                const eventStart = new Date(item.start.dateTime || item.start.date);
                
                let startDate;
                let endDate = '';

                if (isTimedEvent) {
                    // Beispiel: "21. November 2025, 20:00 Uhr"
                    startDate = eventStart.toLocaleDateString('de-DE', {
                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }).replace(':', ':').trim();
                    
                    // Nur Endzeit extrahieren (z.B. "22:00 Uhr")
                    const eventEnd = new Date(item.end.dateTime);
                    endDate = eventEnd.toLocaleTimeString('de-DE', {
                        hour: '2-digit', minute: '2-digit'
                    }).trim() + ' Uhr';


                } else {
                    // Ganztägige Events
                    const tempDate = new Date(item.start.date);
                    // Korrektur: All-day Events in Google Calendar werden manchmal als 'end: 2025-11-22' und 'start: 2025-11-21' geliefert
                    // Wir nehmen nur den Starttag und ignorieren die Zeit.
                    
                    startDate = tempDate.toLocaleDateString('de-DE', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    }).trim();
                }

                const dayOfMonth = eventStart.getDate();
                const dayOfWeekShort = eventStart.toLocaleDateString('de-DE', {
                    weekday: 'short'
                }).slice(0, 2);
                
                // Monat/Jahr für die Sortierung speichern
                const sortDate = new Date(eventStart.getFullYear(), eventStart.getMonth(), eventStart.getDate());


                return {
                    id: index,
                    title: cleanTitle(rawTitle),
                    date: startDate,
                    endDate: endDate,
                    dayOfMonth: dayOfMonth,
                    dayOfWeekShort: dayOfWeekShort,
                    location: item.location || 'Keine Angabe',
                    description: item.description || 'Keine weitere Beschreibung vorhanden.',
                    providerId: providerId,
                    sortDate: sortDate // Für die korrekte Sortierung
                };
            }).filter(event => event.title.toLowerCase().indexOf('blockiert') === -1); // "Blockiert" filtern

			appLoader.style.display = 'none';
            
            // FILTERLEISTE SICHTBAR MACHEN UND INITIALISIEREN
            createFilterButtons(); 
            filterContainer.style.display = 'block';
            applyCategoryFilter(null);
            
            hideSplash(); 
        })	
        .catch(error => {
            headerTitle.textContent = "Fehler beim Laden!";
            contentDiv.innerHTML = `<p style="margin: 20px; color: red;">Konnte Events nicht laden: ${error.message}.</p>`;
            console.error("Error fetching events:", error);
            hideSplash(); 
        });
}
	
// --- 4. FUNKTIONEN ZUM RENDERN DER LISTEN (MIT MONATSTRENNUNG) ---
function renderEventList(eventsToRender = dynamicEvents) {
    headerTitle.textContent = "Veranstaltungen";
    contentDiv.innerHTML = '';
    
    // Sortierung der Events nach Datum
    eventsToRender.sort((a, b) => a.sortDate - b.sortDate);

    if (eventsToRender.length === 0) {
        contentDiv.innerHTML = `<p style="margin: 20px;">Keine zukünftigen Veranstaltungen gefunden.</p>`;
        return;
    }
    
    let currentMonth = null;
    const dateFormatter = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' });

    eventsToRender.forEach(event => {
        const provider = providers.find(p => p.id == event.providerId);
        const providerName = provider ? provider.name : "Unbekannter Anbieter";
        const cardColor = provider ? provider.color : '#aaaaaa';
        
        // Monat und Jahr formatieren
        const monthAndYear = dateFormatter.format(event.sortDate);
        
        // PRÜFUNG AUF MONATSWECHSEL
        if (monthAndYear !== currentMonth) {
            currentMonth = monthAndYear;
            const separator = document.createElement('div');
            separator.className = 'month-separator';
            separator.textContent = currentMonth;
            contentDiv.appendChild(separator);
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.style.borderLeftColor = cardColor;
        card.style.setProperty('--event-color', cardColor);
        
        card.style.display = 'flex';
        card.style.alignItems = 'flex-start'; 
        
        card.innerHTML = `
            <div class="date-container">
                <div class="date-day-num">${event.dayOfMonth}</div>
                <div class="date-day-short">${event.dayOfWeekShort}</div>
            </div>
            <div class="card-content">
                <h3>${event.title}</h3>
                <p>Datum: ${event.date}</p>
                <p>Anbieter: <strong>${providerName}</strong></p>
            </div>
        `;
        
        card.onclick = () => showEventDetails(event);
        contentDiv.appendChild(card);
    });
}
// --- ENDE FUNKTIONEN ZUM RENDERN DER LISTEN ---

// --- FUNKTIONEN FÜR KATEGORIE-FILTER ---

function createFilterButtons() {
    const filterContainer = document.getElementById('filter-container');
    filterContainer.innerHTML = '';
    
    const allBtn = document.createElement('span');
    allBtn.className = 'filter-btn selected';
    allBtn.textContent = 'Alle Events';
    allBtn.onclick = () => {
        searchInput.value = ''; 
        applyCategoryFilter(null);
    };
    filterContainer.appendChild(allBtn);

    providers.forEach(provider => {
        if (provider.id !== 99 && provider.id !== 11) {
            const btn = document.createElement('span');
            btn.className = 'filter-btn';
            btn.textContent = provider.name;
            btn.onclick = () => {
                searchInput.value = ''; 
                applyCategoryFilter(provider.id);
            };
            filterContainer.appendChild(btn);
        }
    });
}

function applyCategoryFilter(providerId) {
    currentFilterId = providerId;
    
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('selected'));
    
    let targetButton;

    if (providerId === null) {
        targetButton = document.querySelector('#filter-container .filter-btn:first-child'); 
    } else {
        targetButton = Array.from(document.querySelectorAll('.filter-btn')).find(btn => btn.textContent === providers.find(p => p.id === providerId)?.name);
    }
    
    if (targetButton) {
        targetButton.classList.add('selected');
    }

    let filtered;
    if (providerId === null) {
        filtered = dynamicEvents;
    } else {
        filtered = dynamicEvents.filter(event => event.providerId === providerId);
    }

    renderEventList(filtered);
}
// --- ENDE FUNKTIONEN FÜR KATEGORIE-FILTER ---


    function renderProviderList(providersToRender = providers) {
        headerTitle.textContent = "Anbieter";
        contentDiv.innerHTML = '';
        
        // Filterleiste ausblenden
        document.getElementById('filter-container').style.display = 'none';

        providersToRender.forEach(provider => {
            const card = document.createElement('div');
            card.className = 'card';
            
            card.style.display = 'flex';
            card.style.alignItems = 'flex-start';
            
            const cardColor = provider.color || '#aaaaaa';
            
            card.style.borderLeftColor = cardColor;
            card.style.setProperty('--event-color', cardColor);
            
            card.innerHTML = `
                <div class="date-container" style="visibility: hidden;">
                    <div class="date-day-num">00</div>
                    <div class="date-day-short">XX</div>
                </div>
                <div class="card-content">
                    <h3>${provider.name}</h3>
                    <p>Info: ${provider.info}</p>
                </div>
            `;
            card.onclick = () => showVeranstalterDetails(provider.id);
            contentDiv.appendChild(card);
        });
    }

function filterEvents() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (document.getElementById('events-btn').classList.contains('active')) {
        
        const eventsToSearch = dynamicEvents;

        const filteredEvents = eventsToSearch.filter(event => {
            const provider = providers.find(p => p.id == event.providerId);
            const providerName = provider ? provider.name.toLowerCase() : '';
            
            const matchesSearchTerm = event.title.toLowerCase().includes(searchTerm) ||
                                      event.location.toLowerCase().includes(searchTerm) ||
                                      providerName.includes(searchTerm);
                                      
            if (searchTerm.length > 0) {
                return matchesSearchTerm;
            } else {
                return currentFilterId === null || event.providerId === currentFilterId;
            }
        });
        
        if (searchTerm.length > 0) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('selected'));
        } else {
             applyCategoryFilter(currentFilterId);
        }


        renderEventList(filteredEvents);

    } else if (document.getElementById('providers-btn').classList.contains('active')) {
        const filteredProviders = providers.filter(provider => {
            return provider.name.toLowerCase().includes(searchTerm) ||
                   provider.info.toLowerCase().includes(searchTerm);
        });
        renderProviderList(filteredProviders);
    }
}


// --- 5. FUNKTIONEN ZUM ANZEIGEN DER DETAILS (MIT KALENDER-LOGIK) ---

function showEventDetails(event) {
    const provider = providers.find(p => p.id == event.providerId);
    const providerName = provider ? provider.name : "Unbekannter Anbieter";
    const providerColor = provider ? provider.color : '#8B4513';
    const safeLinkColor = '#8B4513';

    const imageUrl = getEmbeddableDriveLink(event.description);
    
    let cleanedDescription = event.description;
    
    const fullLinkRegex = /https:\/\/drive\.google\.com\/(?:file\/d\/|open\?id=)[a-zA-Z0-9_-]+(?:[^ \n\r]*)/g;
    
    if (imageUrl) {
        cleanedDescription = event.description.replace(fullLinkRegex, '').trim();
    }
    
    const imageHtml = imageUrl
        ? `<div class="event-image-container"><img src="${imageUrl}" alt="Event Anhang" class="event-image"></div>`
        : '';

    // NEU: Zeit-Anzeige korrigiert (Timed vs. All-Day)
    let timeDisplay;
    if (event.endDate) {
        // Timed Event: event.date enthält Startdatum/zeit, event.endDate enthält Endzeit
        const startDatePart = event.date.split(',')[0]; // z.B. "21. November 2025"
        const startTimePart = event.date.match(/(\d{2}:\d{2})/)?.[0] || '';
        
        if(startTimePart) {
            // Angabe mit Start- und Endzeit
            timeDisplay = `Am ${startDatePart} von ${startTimePart} bis ${event.endDate}`;
        } else {
            // Falls Startzeit fehlt, nur Datum und Endzeit
            timeDisplay = `${event.date} bis ${event.endDate}`;
        }
    } else {
        timeDisplay = `${event.date} (Ganztägig)`;
    }
        
    const locationEncoded = encodeURIComponent(event.location);
    
    // Korrigierte Google Maps URL
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${locationEncoded}`; 
    const locationLink = `<a href="${mapsUrl}" target="_blank" style="color: ${safeLinkColor}; font-weight: bold;">${event.location} (Auf Karte anzeigen)</a>`;

    // NEU: Kalender-URL generieren
    const googleCalendarUrl = getGoogleCalendarUrl(event); 

    const modalContent = document.getElementById('eventModal').querySelector('.modal-content');
    
    Array.from(modalContent.children).forEach(child => {
        if (!child.classList.contains('close')) {
            child.remove();
        }
    });

    const detailsHTML = `
        <h2 style="color: #8B4513;">${event.title}</h2>
        ${imageHtml}
        <p><strong>Wann:</strong> ${timeDisplay}</p>
        <p><strong>Wo:</strong> ${locationLink}</p>
        
        <hr style="border-top: 1px solid ${providerColor}; margin: 15px 0;">
        
        <p><strong>Anbieter:</strong>
            <strong style="color: ${safeLinkColor}; cursor: pointer;" onclick="showVeranstalterDetails(${event.providerId})">
                ${providerName} (Details anzeigen)
            </strong>
        </p>
        <h3 style="margin-top: 20px;">Beschreibung:</h3>
        <p>${cleanedDescription.replace(/\n/g, '<br>')}</p>
        
		<div class="calendar-buttons">
            <a href="${googleCalendarUrl}" target="_blank" class="calendar-link-btn">
                Zu Google Kalender hinzufügen
            </a>
            <button onclick="downloadICS(window.eventDetailsCache)" class="calendar-link-btn">
                Als .ics-Datei herunterladen (Outlook, Apple)
            </button>
        </div>
        `;
    
    // Event im Cache speichern, um es im ICS-Download verwenden zu können
    window.eventDetailsCache = event;
    
    modalContent.insertAdjacentHTML('beforeend', detailsHTML);
    eventModal.style.display = "block";
}


    function showVeranstalterDetails(providerId) {
        closeModal('eventModal'); 

        const provider = providers.find(p => p.id === providerId);
        if (!provider) {
            console.error("Anbieter nicht gefunden:", providerId);
            return;
        }

        document.getElementById('modalProviderName').textContent = provider.name;
        document.getElementById('modalProviderContact').textContent = provider.contact || 'Keine Angabe';
        document.getElementById('modalProviderInfo').textContent = provider.info || 'Keine weiteren Informationen.';
        
        const linkElement = document.getElementById('modalProviderLink');
        if (provider.link) {
            linkElement.href = provider.link;
            linkElement.style.display = 'inline';
        } else {
            linkElement.style.display = 'none';
        }

        veranstalterModal.style.display = "block";
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }
    
    // NEU: Refresh-Funktion
    function handleRefresh() {
        // 1. Ladehinweis und Spinner anzeigen
        contentDiv.innerHTML = '';
        appLoader.style.display = 'block';
        headerTitle.textContent = "Aktualisiere..."; 

        // 2. Events neu laden (mit Filter-Reset)
        currentFilterId = null;
        searchInput.value = '';
        
        // 3. Nach dem Laden wird der Loader in fetchCalendarEvents wieder versteckt
        fetchCalendarEvents(); 
        
        // 4. Zur Events-Ansicht wechseln, falls nötig
        switchView('events');
    }
    // ENDE NEU: Refresh-Funktion

// --- 6. NAVIGATION UND START (ERWEITERT) ---

function hideAllViews() {
    contentDiv.style.display = 'none';
    whatsappView.style.display = 'none';
    contactView.style.display = 'none';
    filterContainer.style.display = 'none';
    
    // Suchcontainer komplett ausblenden, um den Platz zu entfernen
    searchContainer.style.display = 'none'; 
}

function switchView(view) {
    // 1. Alle Nav-Buttons deaktivieren
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // 2. Alle Inhalte verstecken
    hideAllViews();
    
    // 3. Ansicht wechseln
    if (view === 'events') {
        document.getElementById('events-btn').classList.add('active');
        headerTitle.textContent = "Veranstaltungen";
        contentDiv.style.display = 'block';
        searchContainer.style.display = 'block'; // Suchcontainer anzeigen
        searchInput.style.display = 'block';
        filterContainer.style.display = 'block'; 

        // Bei Event-View: Liste rendern/filtern
        applyCategoryFilter(currentFilterId);

    } else if (view === 'providers') {
        document.getElementById('providers-btn').classList.add('active');
        headerTitle.textContent = "Anbieter";
        contentDiv.style.display = 'block';
        searchContainer.style.display = 'block'; // Suchcontainer anzeigen
        searchInput.style.display = 'block';
        
        // Bei Anbieter-View: Liste rendern
        renderProviderList();

    } else if (view === 'whatsapp') {
        document.getElementById('whatsapp-btn').classList.add('active');
        headerTitle.textContent = "WhatsApp";
        whatsappView.style.display = 'block';
        
    } else if (view === 'contact') {
        document.getElementById('contact-btn').classList.add('active');
        headerTitle.textContent = "Feedback & Impressum"; 
        contactView.style.display = 'block';
    }
}

window.onload = () => {
        fetchCalendarEvents();
        
        // Füge alle Nav-Button-Klicks hinzu
        document.getElementById('events-btn').onclick = () => switchView('events');
        document.getElementById('providers-btn').onclick = () => switchView('providers');
        document.getElementById('whatsapp-btn').onclick = () => switchView('whatsapp');
        document.getElementById('contact-btn').onclick = () => switchView('contact');
        
        // NEU: Refresh Button Event Listener
        document.getElementById('refreshButton').onclick = handleRefresh;

        // Suchfunktion nur für Events/Anbieter
        searchInput.addEventListener('input', filterEvents);
    };

    window.onclick = function(event) {
        if (event.target == eventModal) {
            eventModal.style.display = "none";
        }
        if (event.target == veranstalterModal) {
            veranstalterModal.style.display = "none";
        }
    }
    
    // --- 7. SERVICE WORKER REGISTRIERUNG ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registriert mit Scope:', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker Registrierung fehlgeschlagen:', error);
                });
        });
    }
    // --- ENDE SERVICE WORKER REGISTRIERUNG ---
</script>
</body>
</html>
